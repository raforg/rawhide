#!/bin/sh
#
# rawhide - find files using pretty C expressions
# https://raf.org/rawhide
# https://github.com/raforg/rawhide
# https://codeberg.org/raforg/rawhide
#
# Copyright (C) 1990 Ken Stauffer, 2022-2023 raf <raf@raf.org>
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, see <https://www.gnu.org/licenses/>.
#
# 20231013 raf <raf@raf.org>

. tests/.common

TZ=UTC; export TZ

label="-L/-j option"

touch $d/f
chmod 644 $d/f
touch -t 199002181327.32 $d/f
ln -s f $d/l

test_rawhide "$rh -L ''                                     $d/f"   ""                                 "" 0 "-L ''"
test_rawhide "$rh -L 'abcdefghijklmnopqrstuvwxyz\n'         $d/f"   "abcdefghijklmnopqrstuvwxyz\n"     "" 0 "-L 'abcdefghijklmnopqrstuvwxyz\\\\n'"

test_rawhide "$rh -L '\a\b\f\n\r\t\v\e\\\p\033\0\n'         $d/f"   "\a\b\f\n\r\t\v\033\\\\p\033\0\n"  "" 0 "-L '\\\\a\\\\b\\\\f\\\\n\\\\r\\\\t\\\\v\\\\e\\\\\\\\\\\\p\\\\033\\\\0\\\\n'"
test_rawhide "$rh -L '\a\b\f\n\c\r\t\v\e\\\033\n'           $d/f"   "\a\b\f\n"                         "" 0 "-L '\\\\a\\\\b\\\\f\\\\n\\\\c\\\\r\\\\t\\\\v\\\\e\\\\\\\\\\\\033\\\\n'"
test_rawhide "$rh -L '_\x_\xb_\x1B_\x1bb_\n'                $d/f"   "_\000_\013_\033_\033b_\n"         "" 0 "-L '_\\\\x_\\\\xb_\\\\x1b_\\\\x1bb_\\\\n'"
test_rawhide "$rh -L '_\u_\ub_\u1B_\u01b_\u001B_\u0001b_\n' $d/f"   "_\000_\013_\033_\033_\033_\001b_\n"   "" 0 "-L '_\\\\u_\\\\ub_\\\\u1B_\\\\u01b_\\\\u001B_\\\\u0001b_\\\\n'"
test_rawhide "$rh -L '_\U_\Ub_\U1B_\U01b_\U001B_\U0001b_\U00001B_\U000001b_\U0000001B_\U00000001b_\n' $d/f" "_\000_\013_\033_\033_\033_\033_\033_\033_\033_\001b_\n" "" 0 "-L '_\\\\U_\\\\Ub_\\\\U1B_\\\\U01b_\\\\U001B_\\\\U0001b_\\\\U00001B_\\\\U000001b_\\\\U0000001B_\\\\U00000001b_\\\\n'"
test_rawhide "$rh -L '\ud800_\Ud800\n'                      $d/f"   "\\\\ud800_\\\\Ud800\n"            "" 0 "-L '\\\\ud800\\\\Ud800\\\\n' (invalid code point)"
test_rawhide "$rh -L '\z\n'                                 $d/f"   "\\\\z\n"                          "" 0 "-L '\\\\z\\\\n'"
test_rawhide "$rh -L '\'                                    $d/f"   "\\\\"                             "" 0 "-L '\\\\'"

test_rawhide "$rh -L '%%\n'        $d/f" "%%\n"                        ""                                               0 "-L '%%\\\\n'"

test_rawhide "LANG=C $rh -L '%a\n'        $d/f" "Sun Feb 18 13:27:32 1990\n"  ""                                               0 "-L '%a\\\\n'"
test_rawhide "LANG=C $rh -L '%25a\n'      $d/f" " Sun Feb 18 13:27:32 1990\n" ""                                               0 "-L '%25a\\\\n'"
test_rawhide "LANG=C $rh -L '%-25a\n'     $d/f" "Sun Feb 18 13:27:32 1990 \n" ""                                               0 "-L '%-25a\\\\n'"
test_rawhide "LANG=C $rh -L '%.15a\n'     $d/f" "Sun Feb 18 13:2\n"           ""                                               0 "-L '%.15a\\\\n'"
test_rawhide "LANG=C $rh -L '%25.15a\n'   $d/f" "          Sun Feb 18 13:2\n" ""                                               0 "-L '%25.15a\\\\n'"
test_rawhide "LANG=C $rh -L '%-25.15a\n'  $d/f" "Sun Feb 18 13:2          \n" ""                                               0 "-L '%-25.15a\\\\n'"

test_rawhide "$rh -L '%A'          $d/f" ""                            "./rh: invalid %%A conversion: %%A\n"            1 "-L '%A' (invalid)"
test_rawhide "$rh -L '%A?'         $d/f" ""                            "./rh: invalid %%A conversion: %%A?\n"           1 "-L '%A?' (invalid)"
test_rawhide "$rh -L '%25A'        $d/f" ""                            "./rh: invalid %%A conversion: %%25A\n"          1 "-L '%25A' (invalid)"
test_rawhide "$rh -L '%-25A'       $d/f" ""                            "./rh: invalid %%A conversion: %%-25A\n"         1 "-L '%-25A' (invalid)"
test_rawhide "$rh -L '%.15A'       $d/f" ""                            "./rh: invalid %%A conversion: %%.15A\n"         1 "-L '%.15A' (invalid)"
test_rawhide "$rh -L '%25.15A'     $d/f" ""                            "./rh: invalid %%A conversion: %%25.15A\n"       1 "-L '%25.15A' (invalid)"
test_rawhide "$rh -L '%-25.15A'    $d/f" ""                            "./rh: invalid %%A conversion: %%-25.15A\n"      1 "-L '%-25.15A' (invalid)"

test_rawhide "$rh -L '%A\n'        $d/f" ""                            "./rh: invalid %%A conversion: %%A\\\\n\n"       1 "-L '%A\\\\n' (invalid)"
test_rawhide "$rh -L '%25A\n'      $d/f" ""                            "./rh: invalid %%A conversion: %%25A\\\\n\n"     1 "-L '%25A\\\\n' (invalid)"
test_rawhide "$rh -L '%-25A\n'     $d/f" ""                            "./rh: invalid %%A conversion: %%-25A\\\\n\n"    1 "-L '%-25A\\\\n' (invalid)"
test_rawhide "$rh -L '%.15A\n'     $d/f" ""                            "./rh: invalid %%A conversion: %%.15A\\\\n\n"    1 "-L '%.15A\\\\n' (invalid)"
test_rawhide "$rh -L '%25.15A\n'   $d/f" ""                            "./rh: invalid %%A conversion: %%25.15A\\\\n\n"  1 "-L '%25.15A\\\\n' (invalid)"
test_rawhide "$rh -L '%-25.15A\n'  $d/f" ""                            "./rh: invalid %%A conversion: %%-25.15A\\\\n\n" 1 "-L '%-25.15A\\\\n' (invalid)"

test_rawhide "$rh -L '%A@\n'       $d/f" "635347652.000000000\n"                 ""                                     0 "-L '%A@\\\\n'"
test_rawhide "$rh -L '%25A@\n'     $d/f" "      635347652.000000000\n"           ""                                     0 "-L '%25A@\\\\n'"
test_rawhide "$rh -L '%025A@\n'    $d/f" "000000635347652.000000000\n"           ""                                     0 "-L '%025A@\\\\n'"
test_rawhide "$rh -L '% 25A@\n'    $d/f" "      635347652.000000000\n"           ""                                     0 "-L '% 25A@\\\\n'"
test_rawhide "$rh -L '%+25A@\n'    $d/f" "     +635347652.000000000\n"           ""                                     0 "-L '%+25A@\\\\n'"
test_rawhide "$rh -L '%-25A@\n'    $d/f" "635347652.000000000      \n"           ""                                     0 "-L '%-25A@\\\\n'"
test_rawhide "$rh -L '%#25A@\n'    $d/f" "      635347652.000000000\n"           ""                                     0 "-L '%#25A@\\\\n'"
test_rawhide "$rh -L '%.15A@\n'    $d/f" "635347652.000000000000000\n"           ""                                     0 "-L '%.15A@\\\\n'"
test_rawhide "$rh -L '%35.15A@\n'  $d/f" "          635347652.000000000000000\n" ""                                     0 "-L '%35.15A@\\\\n'"
test_rawhide "$rh -L '%-35.15A@\n' $d/f" "635347652.000000000000000          \n" ""                                     0 "-L '%-35.15A@\\\\n'"

test_rawhide "$rh -L '%25.5A@\n'   $d/f" "          635347652.00000\n" ""                                     0 "-L '%25.5A@\\\\n'"
test_rawhide "$rh -L '%-25.5A@\n'  $d/f" "635347652.00000          \n" ""                                     0 "-L '%-25.5A@\\\\n'"
test_rawhide "$rh -L '%25.1A@\n'   $d/f" "              635347652.0\n" ""                                     0 "-L '%25.1A@\\\\n'"
test_rawhide "$rh -L '%-25.1A@\n'  $d/f" "635347652.0              \n" ""                                     0 "-L '%-25.1A@\\\\n'"
test_rawhide "$rh -L '%25.0A@\n'   $d/f" "                635347652\n" ""                                     0 "-L '%25.0A@\\\\n'"
test_rawhide "$rh -L '%-25.0A@\n'  $d/f" "635347652                \n" ""                                     0 "-L '%-25.0A@\\\\n'"
test_rawhide "$rh -L '%#25.0A@\n'  $d/f" "               635347652.\n" ""                                     0 "-L '%#25.0A@\\\\n'"
test_rawhide "$rh -L '%#-25.0A@\n' $d/f" "635347652.               \n" ""                                     0 "-L '%#-25.0A@\\\\n'"
test_rawhide "$rh -L '%25.A@\n'    $d/f" "                635347652\n" ""                                     0 "-L '%25.A@\\\\n'"
test_rawhide "$rh -L '%-25.A@\n'   $d/f" "635347652                \n" ""                                     0 "-L '%-25.A@\\\\n'"
test_rawhide "$rh -L '%#25.A@\n'   $d/f" "               635347652.\n" ""                                     0 "-L '%#25.A@\\\\n'"
test_rawhide "$rh -L '%#-25.A@\n'  $d/f" "635347652.               \n" ""                                     0 "-L '%#-25.A@\\\\n'"

test_rawhide "$rh -L '%+25A@\n'    $d/f" "     +635347652.000000000\n" ""                                     0 "-L '%+25A@\\\\n'"
test_rawhide "$rh -L '%0+25A@\n'   $d/f" "+00000635347652.000000000\n" ""                                     0 "-L '%0+25A@\\\\n'"
test_rawhide "$rh -L '% 25A@\n'    $d/f" "      635347652.000000000\n" ""                                     0 "-L '% 25A@\\\\n'"
test_rawhide "$rh -L '%0 25A@\n'   $d/f" " 00000635347652.000000000\n" ""                                     0 "-L '%0 25A@\\\\n'"
test_rawhide "$rh -L '%+ 25A@\n'   $d/f" "     +635347652.000000000\n" ""                                     0 "-L '%+ 25A@\\\\n'"
test_rawhide "$rh -L '%0+ 25A@\n'  $d/f" "+00000635347652.000000000\n" ""                                     0 "-L '%0+ 25A@\\\\n'"

touch -t 196002181327.32 $d/f2
test_rawhide "$rh -L '%+25A@\n'    $d/f2" "     -311423548.000000000\n" ""                                     0 "-L '%+25A@\\\\n' negative"
test_rawhide "$rh -L '%0+25A@\n'   $d/f2" "-00000311423548.000000000\n" ""                                     0 "-L '%0+25A@\\\\n' negative"
test_rawhide "$rh -L '% 25A@\n'    $d/f2" "     -311423548.000000000\n" ""                                     0 "-L '% 25A@\\\\n' negative"
test_rawhide "$rh -L '%0 25A@\n'   $d/f2" "-00000311423548.000000000\n" ""                                     0 "-L '%0 25A@\\\\n' negative"
test_rawhide "$rh -L '%+ 25A@\n'   $d/f2" "     -311423548.000000000\n" ""                                     0 "-L '%+ 25A@\\\\n' negative"
test_rawhide "$rh -L '%0+ 25A@\n'  $d/f2" "-00000311423548.000000000\n" ""                                     0 "-L '%0+ 25A@\\\\n' negative"
rm $d/f2

test_rawhide "$rh -L '%Ad\n'       $d/f" "18\n"                        ""                                               0 "-L '%Ad\\\\n'"
test_rawhide "$rh -L '%5Ad\n'      $d/f" "   18\n"                     ""                                               0 "-L '%5Ad\\\\n'"
test_rawhide "$rh -L '%-5Ad\n'     $d/f" "18   \n"                     ""                                               0 "-L '%-5Ad\\\\n'"
test_rawhide "$rh -L '%6.5Ad\n'    $d/f" "    18\n"                    ""                                               0 "-L '%6.5Ad\\\\n'"
test_rawhide "$rh -L '%-6.5Ad\n'   $d/f" "18    \n"                    ""                                               0 "-L '%-6.5Ad\\\\n'"

test_rawhide "$rh -L '%AH\n'       $d/f" "13\n"                        ""                                               0 "-L '%AH\\\\n'"
test_rawhide "$rh -L '%5AH\n'      $d/f" "   13\n"                     ""                                               0 "-L '%5AH\\\\n'"
test_rawhide "$rh -L '%-5AH\n'     $d/f" "13   \n"                     ""                                               0 "-L '%-5AH\\\\n'"
test_rawhide "$rh -L '%6.5AH\n'    $d/f" "    13\n"                    ""                                               0 "-L '%6.5AH\\\\n'"
test_rawhide "$rh -L '%-6.5AH\n'   $d/f" "13    \n"                    ""                                               0 "-L '%-6.5AH\\\\n'"

case "`uname`" in
	FreeBSD|SunOS) # zfs
		test_rawhide "$rh -L '%b\n'     $d/f" "1\n"      "" 0 "-L '%b\\\\n'"
		test_rawhide "$rh -L '%5b\n'    $d/f" "    1\n"  "" 0 "-L '%5b\\\\n'"
		test_rawhide "$rh -L '%05b\n'   $d/f" "00001\n"  "" 0 "-L '%05b\\\\n'"
		test_rawhide "$rh -L '% b\n'    $d/f" " 1\n"     "" 0 "-L '% 5b\\\\n'"
		test_rawhide "$rh -L '% 5b\n'   $d/f" "    1\n"  "" 0 "-L '% 5b\\\\n'"
		test_rawhide "$rh -L '%+5b\n'   $d/f" "   +1\n"  "" 0 "-L '%+5b\\\\n'"
		test_rawhide "$rh -L '%-5b\n'   $d/f" "1    \n"  "" 0 "-L '%-5b\\\\n'"
		test_rawhide "$rh -L '%#5b\n'   $d/f" "    1\n"  "" 0 "-L '%#5b\\\\n'"
		test_rawhide "$rh -L '%.5b\n'   $d/f" "00001\n"  "" 0 "-L '%.5b\\\\n'"
		test_rawhide "$rh -L '%6.5b\n'  $d/f" " 00001\n" "" 0 "-L '%6.5b\\\\n'"
		test_rawhide "$rh -L '%-6.5b\n' $d/f" "00001 \n" "" 0 "-L '%-6.5b\\\\n'"
		;;
	*)
		test_rawhide "$rh -L '%b\n'     $d/f" "0\n"      "" 0 "-L '%b\\\\n'"
		test_rawhide "$rh -L '%5b\n'    $d/f" "    0\n"  "" 0 "-L '%5b\\\\n'"
		test_rawhide "$rh -L '%05b\n'   $d/f" "00000\n"  "" 0 "-L '%05b\\\\n'"
		test_rawhide "$rh -L '% b\n'    $d/f" " 0\n"     "" 0 "-L '% 5b\\\\n'"
		test_rawhide "$rh -L '% 5b\n'   $d/f" "    0\n"  "" 0 "-L '% 5b\\\\n'"
		test_rawhide "$rh -L '%+5b\n'   $d/f" "   +0\n"  "" 0 "-L '%+5b\\\\n'"
		test_rawhide "$rh -L '%-5b\n'   $d/f" "0    \n"  "" 0 "-L '%-5b\\\\n'"
		test_rawhide "$rh -L '%#5b\n'   $d/f" "    0\n"  "" 0 "-L '%#5b\\\\n'"
		test_rawhide "$rh -L '%.5b\n'   $d/f" "00000\n"  "" 0 "-L '%.5b\\\\n'"
		test_rawhide "$rh -L '%6.5b\n'  $d/f" " 00000\n" "" 0 "-L '%6.5b\\\\n'"
		test_rawhide "$rh -L '%-6.5b\n' $d/f" "00000 \n" "" 0 "-L '%-6.5b\\\\n'"
		;;
esac

test_rawhide_grep "$rh -L '%B\n'      $d/f" "^[0-9]+$"     "" 0 "-L '%B\\\\n'"
test_rawhide_grep "$rh -L '%25B\n'    $d/f" "^ +[0-9]+$"   "" 0 "-L '%25B\\\\n'"
test_rawhide_grep "$rh -L '%025B\n'   $d/f" "^[0-9]+$"     "" 0 "-L '%025B\\\\n'"
test_rawhide_grep "$rh -L '% B\n'     $d/f" "^ [0-9]+$"    "" 0 "-L '% B\\\\n'"
test_rawhide_grep "$rh -L '% 25B\n'   $d/f" "^ +[0-9]+$"   "" 0 "-L '% 25B\\\\n'"
test_rawhide_grep "$rh -L '%+25B\n'   $d/f" "^ +\+[0-9]+$" "" 0 "-L '%+25B\\\\n'"
test_rawhide_grep "$rh -L '%-25B\n'   $d/f" "^[0-9]+ +$"   "" 0 "-L '%-25B\\\\n'"
test_rawhide_grep "$rh -L '%#25B\n'   $d/f" "^ +[0-9]+$"   "" 0 "-L '%#25B\\\\n'"
test_rawhide_grep "$rh -L '%.25B\n'   $d/f" "^[0-9]+$"     "" 0 "-L '%.25B\\\\n'"
test_rawhide_grep "$rh -L '%25.5B\n'  $d/f" "^ +[0-9]+$"   "" 0 "-L '%25.5B\\\\n'"
test_rawhide_grep "$rh -L '%-25.5B\n' $d/f" "^[0-9]+ +$"   "" 0 "-L '%-25.5B\\\\n'"

day="[A-Z][a-z][a-z]"
mon="[A-Z][a-z][a-z]"
dom="[ 0-9][0-9]"
time="[0-9][0-9]:[0-9][0-9]:[0-9][0-9]"
parttime="[0-9][0-9]:[0-9]"
year="[0-9][0-9][0-9][0-9]"

test_rawhide_grep "LANG=C $rh -L '%c\n'        $d/f"                          "$day $mon $dom $time $year"          ""                                                0 "-L '%c\\\\n'"
test_rawhide_grep "LANG=C $rh -L '%c\n'        $d/f"                          "$day $mon $dom $time $year"          ""                                                0 "-L '%a\\\\n'"
test_rawhide_grep "LANG=C $rh -L '%25c\n'      $d/f"                          " $day $mon $dom $time $year"         ""                                                0 "-L '%25c\\\\n'"
test_rawhide_grep "LANG=C $rh -L '%-25c\n'     $d/f"                          "$day $mon $dom $time $year "         ""                                                0 "-L '%-25c\\\\n'"
test_rawhide_grep "LANG=C $rh -L '%.15c\n'     $d/f"                          "$day $mon $dom $parttime"            ""                                                0 "-L '%.15c\\\\n'"
test_rawhide_grep "LANG=C $rh -L '%25.15c\n'   $d/f"                          "          $day $mon $dom $parttime"  ""                                                0 "-L '%25.15c\\\\n'"
test_rawhide_grep "LANG=C $rh -L '%-25.15c\n'  $d/f"                          "$day $mon $dom $parttime          "  ""                                                0 "-L '%-25.15c\\\\n'"

test_rawhide "$rh -L '%C'               $d/f"                          ""                            "./rh: invalid %%C conversion: %%C\n"            1 "-L '%C' (invalid)"
test_rawhide "$rh -L '%C?'              $d/f"                          ""                            "./rh: invalid %%C conversion: %%C?\n"           1 "-L '%C?' (invalid)"
test_rawhide "$rh -L '%25C'             $d/f"                          ""                            "./rh: invalid %%C conversion: %%25C\n"          1 "-L '%25C' (invalid)"
test_rawhide "$rh -L '%-25C'            $d/f"                          ""                            "./rh: invalid %%C conversion: %%-25C\n"         1 "-L '%-25C' (invalid)"
test_rawhide "$rh -L '%.15C'            $d/f"                          ""                            "./rh: invalid %%C conversion: %%.15C\n"         1 "-L '%.15C' (invalid)"
test_rawhide "$rh -L '%25.15C'          $d/f"                          ""                            "./rh: invalid %%C conversion: %%25.15C\n"       1 "-L '%25.15C' (invalid)"
test_rawhide "$rh -L '%-25.15C'         $d/f"                          ""                            "./rh: invalid %%C conversion: %%-25.15C\n"      1 "-L '%-25.15C' (invalid)"

test_rawhide "$rh -L '%C\n'             $d/f"                          ""                            "./rh: invalid %%C conversion: %%C\\\\n\n"       1 "-L '%C\\\\n' (invalid)"
test_rawhide "$rh -L '%25C\n'           $d/f"                          ""                            "./rh: invalid %%C conversion: %%25C\\\\n\n"     1 "-L '%25C\\\\n' (invalid)"
test_rawhide "$rh -L '%-25C\n'          $d/f"                          ""                            "./rh: invalid %%C conversion: %%-25C\\\\n\n"    1 "-L '%-25C\\\\n' (invalid)"
test_rawhide "$rh -L '%.15C\n'          $d/f"                          ""                            "./rh: invalid %%C conversion: %%.15C\\\\n\n"    1 "-L '%.15C\\\\n' (invalid)"
test_rawhide "$rh -L '%25.15C\n'        $d/f"                          ""                            "./rh: invalid %%C conversion: %%25.15C\\\\n\n"  1 "-L '%25.15C\\\\n' (invalid)"
test_rawhide "$rh -L '%-25.15C\n'       $d/f"                          ""                            "./rh: invalid %%C conversion: %%-25.15C\\\\n\n" 1 "-L '%-25.15C\\\\n' (invalid)"

dd="[0-9]"
tm="$dd$dd$dd$dd$dd$dd$dd$dd$dd$dd" # Until about 2286 CE
ns="$dd$dd$dd$dd$dd$dd$dd$dd$dd"
d5="$dd$dd$dd$dd$dd"

test_rawhide_grep "$rh -L '%C@\n'       $d/f"                         "$tm.$ns"                 ""                                    0 "-L '%C@\\\\n'"
test_rawhide_grep "$rh -L '%25C@\n'     $d/f"                         "     $tm.$ns"            ""                                    0 "-L '%25C@\\\\n'"
test_rawhide_grep "$rh -L '%025C@\n'    $d/f"                         "00000$tm.$ns"            ""                                    0 "-L '%025C@\\\\n'"
test_rawhide_grep "$rh -L '% 25C@\n'    $d/f"                         "     $tm.$ns"            ""                                    0 "-L '% 25C@\\\\n'"
test_rawhide_grep "$rh -L '%+25C@\n'    $d/f"                         "    \+$tm.$ns"            ""                                    0 "-L '%+25C@\\\\n'"
test_rawhide_grep "$rh -L '%-25C@\n'    $d/f"                         "$tm.$ns     "            ""                                    0 "-L '%-25C@\\\\n'"
test_rawhide_grep "$rh -L '%#25C@\n'    $d/f"                         "     $tm.$ns"            ""                                    0 "-L '%#25C@\\\\n'"
test_rawhide_grep "$rh -L '%.15C@\n'    $d/f"                         "$tm.$ns000000"           ""                                    0 "-L '%.15C@\\\\n'"
test_rawhide_grep "$rh -L '%35.15C@\n'  $d/f"                         "         $tm.$ns$d5$dd"  ""                                    0 "-L '%35.15C@\\\\n'"
test_rawhide_grep "$rh -L '%-35.15C@\n' $d/f"                         "$tm.$ns$d5$dd         "  ""                                    0 "-L '%-35.15C@\\\\n'"

test_rawhide_grep "$rh -L '%25.5C@\n'   $d/f"                         "         $tm[.]$d5\$"     ""                                     0 "-L '%25.5C@\\\\n'"
test_rawhide_grep "$rh -L '%-25.5C@\n'  $d/f"                         "$tm[.]$d5         \$"     ""                                     0 "-L '%-25.5C@\\\\n'"
test_rawhide_grep "$rh -L '%25.1C@\n'   $d/f"                         "             $tm[.]$dd\$" ""                                     0 "-L '%25.1C@\\\\n'"
test_rawhide_grep "$rh -L '%-25.1C@\n'  $d/f"                         "$tm[.]$dd             \$" ""                                     0 "-L '%-25.1C@\\\\n'"
test_rawhide_grep "$rh -L '%25.0C@\n'   $d/f"                         "               $tm\$"     ""                                     0 "-L '%25.0C@\\\\n'"
test_rawhide_grep "$rh -L '%-25.0C@\n'  $d/f"                         "$tm               \$"     ""                                     0 "-L '%-25.0C@\\\\n'"
test_rawhide_grep "$rh -L '%#25.0C@\n'  $d/f"                         "              $tm[.]\$"   ""                                     0 "-L '%#25.0C@\\\\n'"
test_rawhide_grep "$rh -L '%#-25.0C@\n' $d/f"                         "$tm[.]              \$"   ""                                     0 "-L '%#-25.0C@\\\\n'"
test_rawhide_grep "$rh -L '%25.C@\n'    $d/f"                         "               $tm\$"     ""                                     0 "-L '%25.C@\\\\n'"
test_rawhide_grep "$rh -L '%-25.C@\n'   $d/f"                         "$tm               \$"     ""                                     0 "-L '%-25.C@\\\\n'"
test_rawhide_grep "$rh -L '%#25.C@\n'   $d/f"                         "              $tm[.]\$"   ""                                     0 "-L '%#25.C@\\\\n'"
test_rawhide_grep "$rh -L '%#-25.C@\n'  $d/f"                         "$tm[.]              \$"   ""                                     0 "-L '%#-25.C@\\\\n'"

test_rawhide_grep "$rh -L '%+25C@\n'    $d/f"                         "    \+$tm.$ns\$"          ""                                     0 "-L '%+25C@\\\\n'"
test_rawhide_grep "$rh -L '%0+25C@\n'   $d/f"                         "\+0000$tm.$ns\$"          ""                                     0 "-L '%0+25C@\\\\n'"
test_rawhide_grep "$rh -L '% 25C@\n'    $d/f"                         "     $tm.$ns\$"           ""                                     0 "-L '% 25C@\\\\n'"
test_rawhide_grep "$rh -L '%0 25C@\n'   $d/f"                         " 0000$tm.$ns\$"           ""                                     0 "-L '%0 25C@\\\\n'"
test_rawhide_grep "$rh -L '%+ 25C@\n'   $d/f"                         "    \+$tm.$ns\$"          ""                                     0 "-L '%+ 25C@\\\\n'"
test_rawhide_grep "$rh -L '%0+ 25C@\n'  $d/f"                         "\+0000$tm.$ns\$"          ""                                     0 "-L '%0+ 25C@\\\\n'"

tm="[0-9][0-9]"
test_rawhide_grep "$rh -L '%Cd\n'       $d/f"                          "$tm"                ""                                        0 "-L '%Ca\\\\n'"
test_rawhide_grep "$rh -L '%5Cd\n'      $d/f"                          "   $tm"             ""                                        0 "-L '%-Ca\\\\n'"
test_rawhide_grep "$rh -L '%-5Cd\n'     $d/f"                          "$tm   "             ""                                        0 "-L '%-5Ca\\\\n'"
test_rawhide_grep "$rh -L '%6.5Cd\n'    $d/f"                          "   $tm"             ""                                        0 "-L '%6.5Ca\\\\n'"
test_rawhide_grep "$rh -L '%-6.5Cd\n'   $d/f"                          "$tm    "            ""                                        0 "-L '%-6.5Ca\\\\n'"

test_rawhide_grep "$rh -L '%CH\n'       $d/f"                          "$tm"                ""                                        0 "-L '%CH\\\\n'"
test_rawhide_grep "$rh -L '%5CH\n'      $d/f"                          "   $tm"             ""                                        0 "-L '%-CH\\\\n'"
test_rawhide_grep "$rh -L '%-5CH\n'     $d/f"                          "$tm   "             ""                                        0 "-L '%-5CH\\\\n'"
test_rawhide_grep "$rh -L '%6.5CH\n'    $d/f"                          "   $tm"             ""                                        0 "-L '%6.5CH\\\\n'"
test_rawhide_grep "$rh -L '%-6.5CH\n'   $d/f"                          "$tm    "            ""                                        0 "-L '%-6.5CH\\\\n'"

test_rawhide      "$rh -L '%C'          $d/f"                          ""                  "./rh: invalid %%C conversion: %%C\n"      1 "-L '%C' (invalid)"
test_rawhide      "$rh -L '%C\n'        $d/f"                          ""                  "./rh: invalid %%C conversion: %%C\\\\n\n" 1 "-L '%C\\\\n' (invalid)"
test_rawhide_grep "$rh -L '%C@\n'       $d/f"                          "^[0-9]+.$ns\$"     ""                                         0 "-L '%C@\\\\n'"
test_rawhide_grep "$rh -L '%Cd\n'       $d/f"                          "^[0-9]+\$"         ""                                         0 "-L '%Ca\\\\n'"
test_rawhide_grep "$rh -L '%CH\n'       $d/f"                          "^[0-9]+\$"         ""                                         0 "-L '%CH\\\\n'"

test_rawhide "$rh -L '%d\n'             $d/f"                          "0\n"               ""                                         0 "-L '%d\\\\n'"
test_rawhide "$rh -L '%5d\n'            $d/f"                          "    0\n"           ""                                         0 "-L '%5d\\\\n'"
test_rawhide "$rh -L '%05d\n'           $d/f"                          "00000\n"           ""                                         0 "-L '%05d\\\\n'"
test_rawhide "$rh -L '% 5d\n'           $d/f"                          "    0\n"           ""                                         0 "-L '% 5d\\\\n'"
test_rawhide "$rh -L '%+5d\n'           $d/f"                          "   +0\n"           ""                                         0 "-L '%+5d\\\\n'"
test_rawhide "$rh -L '%-5d\n'           $d/f"                          "0    \n"           ""                                         0 "-L '%-5d\\\\n'"
test_rawhide "$rh -L '%#5d\n'           $d/f"                          "    0\n"           ""                                         0 "-L '%#5d\\\\n'"
test_rawhide "$rh -L '%.5d\n'           $d/f"                          "00000\n"           ""                                         0 "-L '%.5d\\\\n'"
test_rawhide "$rh -L '%6.5d\n'          $d/f"                          " 00000\n"          ""                                         0 "-L '%6.5d\\\\n'"
test_rawhide "$rh -L '%-6.5d\n'         $d/f"                          "00000 \n"          ""                                         0 "-L '%-6.5d\\\\n'"

test_rawhide_grep "$rh -L '%D\n'        $d/f"                          "^[0-9]+\$"         ""                                         0 "-L '%D\\\\n'"
test_rawhide_grep "$rh -L '%25D\n'      $d/f"                          "^ +[0-9]+\$"       ""                                         0 "-L '%25D\\\\n'"
test_rawhide_grep "$rh -L '%025D\n'     $d/f"                          "^0[0-9]+\$"        ""                                         0 "-L '%025D\\\\n'"
test_rawhide_grep "$rh -L '% 25D\n'     $d/f"                          "^ +[0-9]+\$"       ""                                         0 "-L '% 25D\\\\n'"
test_rawhide_grep "$rh -L '%+25D\n'     $d/f"                          "^ +\+[0-9]+\$"     ""                                         0 "-L '%+25D\\\\n'"
test_rawhide_grep "$rh -L '%-25D\n'     $d/f"                          "^[0-9]+ +\$"       ""                                         0 "-L '%-25D\\\\n'"
test_rawhide_grep "$rh -L '%#25D\n'     $d/f"                          "^ +[0-9]+\$"       ""                                         0 "-L '%#25D\\\\n'"
test_rawhide_grep "$rh -L '%.5D\n'      $d/f"                          "^[0-9]+\$"         ""                                         0 "-L '%.5D\\\\n'"
test_rawhide_grep "$rh -L '%25.5D\n'    $d/f"                          "^ +[0-9]+\$"       ""                                         0 "-L '%25.5D\\\\n'"
test_rawhide_grep "$rh -L '%-25.5D\n'   $d/f"                          "^[0-9]+ +\$"       ""                                         0 "-L '%-25.5D\\\\n'"

test_rawhide_grep "$rh -L '%E\n'        /dev/null"                     "^[0-9]+\$"         ""                                         0 "-L '%E\\\\n'"
test_rawhide_grep "$rh -L '%25E\n'      /dev/null"                     "^ +[0-9]+\$"       ""                                         0 "-L '%25E\\\\n'"
test_rawhide_grep "$rh -L '%025E\n'     /dev/null"                     "^0[0-9]+\$"        ""                                         0 "-L '%025E\\\\n'"
test_rawhide_grep "$rh -L '% 25E\n'     /dev/null"                     "^ +[0-9]+\$"       ""                                         0 "-L '% 25E\\\\n'"
test_rawhide_grep "$rh -L '%+25E\n'     /dev/null"                     "^ +\+[0-9]+\$"     ""                                         0 "-L '%+25E\\\\n'"
test_rawhide_grep "$rh -L '%-25E\n'     /dev/null"                     "^[0-9]+ +\$"       ""                                         0 "-L '%-25E\\\\n'"
test_rawhide_grep "$rh -L '%#25E\n'     /dev/null"                     "^ +[0-9]+\$"       ""                                         0 "-L '%#25E\\\\n'"
test_rawhide_grep "$rh -L '%.5E\n'      /dev/null"                     "^[0-9]+\$"         ""                                         0 "-L '%.5E\\\\n'"
test_rawhide_grep "$rh -L '%25.5E\n'    /dev/null"                     "^ +[0-9]+\$"       ""                                         0 "-L '%25.5E\\\\n'"
test_rawhide_grep "$rh -L '%-25.5E\n'   /dev/null"                     "^[0-9]+ +\$"       ""                                         0 "-L '%-25.5E\\\\n'"

test_rawhide "RAWHIDE_TEST_TTY=1 $rh -L '%f\n' $d/f"                   "f\n"               ""                                         0 "-L '%f\\\\n' (tty)"

test_rawhide "$rh -L '%f\n'             $d/f" "f\n"                                        ""                                         0 "-L '%f\\\\n'"
test_rawhide "$rh -L '%8f\n'            $d/f" "       f\n"                                 ""                                         0 "-L '%8f\\\\n'"
test_rawhide "$rh -L '%-8f\n'           $d/f" "f       \n"                                 ""                                         0 "-L '%-8f\\\\n'"
test_rawhide "$rh -L '%8.0f\n'          $d/f" "        \n"                                 ""                                         0 "-L '%8.5f\\\\n'"
test_rawhide "$rh -L '%-8.0f\n'         $d/f" "        \n"                                 ""                                         0 "-L '%-8.5f\\\\n'"

if [ `locale charmap` = UTF-8 ]
then
	# Test -L field width/precision for strings with multi-byte and multi-charwidth characters
	#
	# Note: macOS won't create non-utf8 file names so we just skip these tests there
	# Note: NetBSD's wcwidth() is broken (it returns -1 instead of 2 for emojis)
	# Note: Solaris is like NetBSD but worse. It also thinks Roman Numeral One is two characters wide
	# Note: Cygwin doesn't work either.
	#
	# Apparently, wcwidth() is notoriously broken, and fundamentally useless
	# when faced with complex grapheme clusters.
	# We should be using wcswidth instead but apparently that is broken too.
	# And it would need to be done repeatedly so it would be slower.
	#
	# There are attempts to generate a working wcwidth from Unicode data but they don't work for me.
	#
	# But this is still a big improvement for accented latin characters and asian
	# characters on all systems, and for simple emoji on Linux, FreeBSD, OpenBSD, and macOS.

	case "`uname`" in
		Darwin|NetBSD|SunOS|CYGWIN*)
			;;
		*)
			mkdir $d/d
			touch $d/d/$(printf 'abcdéf')
			touch $d/d/$(printf 'abc\370def')
			touch $d/d/$(printf 'abc\342\205\240def')
			touch $d/d/$(printf 'abc\360\237\231\202def')
			touch $d/d/$(printf 'abc\370\342\205\240\360\237\231\202def')
			test_rawhide_post_hook() { test_rh_sort_post_hook; }

			test_rawhide "$rh -m1 -L '%f.\n'          $d/d" "abcdéf.\nabc\342\205\240def.\nabc\360\237\231\202def.\nabc\370def.\nabc\370\342\205\240\360\237\231\202def.\n"         "" 0 "-L '%f\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%9f.\n'         $d/d" "   abcdéf.\n  abc\342\205\240def.\n  abc\370def.\n abc\360\237\231\202def.\nabc\370\342\205\240\360\237\231\202def.\n" "" 0 "-L '%9f\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%-9f.\n'        $d/d" "abcdéf   .\nabc\342\205\240def  .\nabc\360\237\231\202def .\nabc\370def  .\nabc\370\342\205\240\360\237\231\202def.\n" "" 0 "-L '%-9f\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%9.0f.\n'       $d/d" "         .\n         .\n         .\n         .\n         .\n"                                                          "" 0 "-L '%9.0f\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%-9.0f.\n'      $d/d" "         .\n         .\n         .\n         .\n         .\n"                                                          "" 0 "-L '%-9.0f\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%9.1f.\n'       $d/d" "        a.\n        a.\n        a.\n        a.\n        a.\n"                                                          "" 0 "-L '%9.1f\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%9.2f.\n'       $d/d" "       ab.\n       ab.\n       ab.\n       ab.\n       ab.\n"                                                          "" 0 "-L '%9.2f\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%9.3f.\n'       $d/d" "      abc.\n      abc.\n      abc.\n      abc.\n      abc.\n"                                                          "" 0 "-L '%9.3f\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%9.4f.\n'       $d/d" "      abc.\n     abcd.\n     abc$(printf '\342\205\240').\n     abc$(printf '\370').\n     abc$(printf '\370').\n"     "" 0 "-L '%9.4f\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%9.5f.\n'       $d/d" "    abcdé.\n    abc\342\205\240d.\n    abc\360\237\231\202.\n    abc\370d.\n    abc\370\342\205\240.\n"                "" 0 "-L '%9.5f\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%9.6f.\n'       $d/d" "    abc\370\342\205\240.\n   abcdéf.\n   abc\342\205\240de.\n   abc\360\237\231\202d.\n   abc\370de.\n"                "" 0 "-L '%9.6f\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%9.7f.\n'       $d/d" "   abcdéf.\n  abc\342\205\240def.\n  abc\360\237\231\202de.\n  abc\370def.\n  abc\370\342\205\240\360\237\231\202.\n"  "" 0 "-L '%9.7f\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%9.8f.\n'       $d/d" "   abcdéf.\n  abc\342\205\240def.\n  abc\370def.\n abc\360\237\231\202def.\n abc\370\342\205\240\360\237\231\202d.\n"  "" 0 "-L '%9.8f\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%9.9f.\n'       $d/d" "   abcdéf.\n  abc\342\205\240def.\n  abc\370def.\n abc\360\237\231\202def.\nabc\370\342\205\240\360\237\231\202de.\n"  "" 0 "-L '%9.9f\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%9.10f.\n'      $d/d" "   abcdéf.\n  abc\342\205\240def.\n  abc\370def.\n abc\360\237\231\202def.\nabc\370\342\205\240\360\237\231\202def.\n" "" 0 "-L '%9.10f\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%9.11f.\n'      $d/d" "   abcdéf.\n  abc\342\205\240def.\n  abc\370def.\n abc\360\237\231\202def.\nabc\370\342\205\240\360\237\231\202def.\n" "" 0 "-L '%9.11f\\\\n' multi-byte multi-width chars"

			test_rawhide "$rh -m1 -L '%10f.\n'        $d/d" "    abcdéf.\n   abc\342\205\240def.\n   abc\370def.\n  abc\360\237\231\202def.\nabc\370\342\205\240\360\237\231\202def.\n" "" 0 "-L '%10f\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%-10f.\n'       $d/d" "abcdéf    .\nabc\342\205\240def   .\nabc\360\237\231\202def  .\nabc\370def   .\nabc\370\342\205\240\360\237\231\202def.\n" "" 0 "-L '%-10f\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%10.0f.\n'      $d/d" "          .\n          .\n          .\n          .\n          .\n"                                                         "" 0 "-L '%10.0f\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%-10.0f.\n'     $d/d" "          .\n          .\n          .\n          .\n          .\n"                                                         "" 0 "-L '%-10.0f\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%10.1f.\n'      $d/d" "         a.\n         a.\n         a.\n         a.\n         a.\n"                                                         "" 0 "-L '%10.1f\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%10.2f.\n'      $d/d" "        ab.\n        ab.\n        ab.\n        ab.\n        ab.\n"                                                         "" 0 "-L '%10.2f\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%10.3f.\n'      $d/d" "       abc.\n       abc.\n       abc.\n       abc.\n       abc.\n"                                                         "" 0 "-L '%10.3f\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%10.4f.\n'      $d/d" "       abc.\n      abcd.\n      abc$(printf '\342\205\240').\n      abc$(printf '\370').\n      abc$(printf '\370').\n"    "" 0 "-L '%10.4f\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%10.5f.\n'      $d/d" "     abcdé.\n     abc\342\205\240d.\n     abc\360\237\231\202.\n     abc\370d.\n     abc\370\342\205\240.\n"               "" 0 "-L '%10.5f\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%10.6f.\n'      $d/d" "     abc\370\342\205\240.\n    abcdéf.\n    abc\342\205\240de.\n    abc\360\237\231\202d.\n    abc\370de.\n"               "" 0 "-L '%10.6f\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%10.7f.\n'      $d/d" "    abcdéf.\n   abc\342\205\240def.\n   abc\360\237\231\202de.\n   abc\370def.\n   abc\370\342\205\240\360\237\231\202.\n" "" 0 "-L '%10.7f\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%10.8f.\n'      $d/d" "    abcdéf.\n   abc\342\205\240def.\n   abc\370def.\n  abc\360\237\231\202def.\n  abc\370\342\205\240\360\237\231\202d.\n" "" 0 "-L '%10.8f\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%10.9f.\n'      $d/d" "    abcdéf.\n   abc\342\205\240def.\n   abc\370def.\n  abc\360\237\231\202def.\n abc\370\342\205\240\360\237\231\202de.\n" "" 0 "-L '%10.9f\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%10.10f.\n'     $d/d" "    abcdéf.\n   abc\342\205\240def.\n   abc\370def.\n  abc\360\237\231\202def.\nabc\370\342\205\240\360\237\231\202def.\n" "" 0 "-L '%10.10f\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%10.11f.\n'     $d/d" "    abcdéf.\n   abc\342\205\240def.\n   abc\370def.\n  abc\360\237\231\202def.\nabc\370\342\205\240\360\237\231\202def.\n" "" 0 "-L '%10.11f\\\\n' multi-byte multi-width chars"

			test_rawhide "$rh -m1 -L '%11f.\n'        $d/d" "     abcdéf.\n    abc\342\205\240def.\n    abc\370def.\n   abc\360\237\231\202def.\n abc\370\342\205\240\360\237\231\202def.\n" "" 0 "-L '%11f\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%-11f.\n'       $d/d" "abcdéf     .\nabc\342\205\240def    .\nabc\360\237\231\202def   .\nabc\370def    .\nabc\370\342\205\240\360\237\231\202def .\n" "" 0 "-L '%-11f\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%11.0f.\n'      $d/d" "           .\n           .\n           .\n           .\n           .\n"                                                         "" 0 "-L '%11.0f\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%-11.0f.\n'     $d/d" "           .\n           .\n           .\n           .\n           .\n"                                                         "" 0 "-L '%-11.0f\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%11.1f.\n'      $d/d" "          a.\n          a.\n          a.\n          a.\n          a.\n"                                                         "" 0 "-L '%11.1f\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%11.2f.\n'      $d/d" "         ab.\n         ab.\n         ab.\n         ab.\n         ab.\n"                                                         "" 0 "-L '%11.2f\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%11.3f.\n'      $d/d" "        abc.\n        abc.\n        abc.\n        abc.\n        abc.\n"                                                         "" 0 "-L '%11.3f\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%11.4f.\n'      $d/d" "        abc.\n       abcd.\n       abc$(printf '\342\205\240').\n       abc$(printf '\370').\n       abc$(printf '\370').\n"    "" 0 "-L '%11.4f\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%11.5f.\n'      $d/d" "      abcdé.\n      abc\342\205\240d.\n      abc\360\237\231\202.\n      abc\370d.\n      abc\370\342\205\240.\n"               "" 0 "-L '%11.5f\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%11.6f.\n'      $d/d" "      abc\370\342\205\240.\n     abcdéf.\n     abc\342\205\240de.\n     abc\360\237\231\202d.\n     abc\370de.\n"               "" 0 "-L '%11.6f\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%11.7f.\n'      $d/d" "     abcdéf.\n    abc\342\205\240def.\n    abc\360\237\231\202de.\n    abc\370def.\n    abc\370\342\205\240\360\237\231\202.\n" "" 0 "-L '%11.7f\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%11.8f.\n'      $d/d" "     abcdéf.\n    abc\342\205\240def.\n    abc\370def.\n   abc\360\237\231\202def.\n   abc\370\342\205\240\360\237\231\202d.\n" "" 0 "-L '%11.8f\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%11.9f.\n'      $d/d" "     abcdéf.\n    abc\342\205\240def.\n    abc\370def.\n   abc\360\237\231\202def.\n  abc\370\342\205\240\360\237\231\202de.\n" "" 0 "-L '%11.9f\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%11.10f.\n'     $d/d" "     abcdéf.\n    abc\342\205\240def.\n    abc\370def.\n   abc\360\237\231\202def.\n abc\370\342\205\240\360\237\231\202def.\n" "" 0 "-L '%11.10f\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%11.11f.\n'     $d/d" "     abcdéf.\n    abc\342\205\240def.\n    abc\370def.\n   abc\360\237\231\202def.\n abc\370\342\205\240\360\237\231\202def.\n" "" 0 "-L '%11.11f\\\\n' multi-byte multi-width chars"

			test_rawhide "$rh -m1 -L '%p.\n'          $d/d" "$d/d/abcdéf.\n$d/d/abc\342\205\240def.\n$d/d/abc\360\237\231\202def.\n$d/d/abc\370def.\n$d/d/abc\370\342\205\240\360\237\231\202def.\n"         "" 0 "-L '%p\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%22p.\n'        $d/d" "   $d/d/abcdéf.\n  $d/d/abc\342\205\240def.\n  $d/d/abc\370def.\n $d/d/abc\360\237\231\202def.\n$d/d/abc\370\342\205\240\360\237\231\202def.\n" "" 0 "-L '%22p\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%-22p.\n'       $d/d" "$d/d/abcdéf   .\n$d/d/abc\342\205\240def  .\n$d/d/abc\360\237\231\202def .\n$d/d/abc\370def  .\n$d/d/abc\370\342\205\240\360\237\231\202def.\n" "" 0 "-L '%-22p\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%22.0p.\n'      $d/d" "                      .\n                      .\n                      .\n                      .\n                      .\n"                                                          "" 0 "-L '%22.0p\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%-22.0p.\n'     $d/d" "                      .\n                      .\n                      .\n                      .\n                      .\n"                                                          "" 0 "-L '%-22.0p\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%22.14p.\n'     $d/d" "        $d/d/a.\n        $d/d/a.\n        $d/d/a.\n        $d/d/a.\n        $d/d/a.\n"                                                          "" 0 "-L '%22.14p\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%22.15p.\n'     $d/d" "       $d/d/ab.\n       $d/d/ab.\n       $d/d/ab.\n       $d/d/ab.\n       $d/d/ab.\n"                                                          "" 0 "-L '%22.15p\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%22.16p.\n'     $d/d" "      $d/d/abc.\n      $d/d/abc.\n      $d/d/abc.\n      $d/d/abc.\n      $d/d/abc.\n"                                                          "" 0 "-L '%22.16p\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%22.17p.\n'     $d/d" "      $d/d/abc.\n     $d/d/abcd.\n     $d/d/abc$(printf '\342\205\240').\n     $d/d/abc$(printf '\370').\n     $d/d/abc$(printf '\370').\n"     "" 0 "-L '%22.17p\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%22.18p.\n'     $d/d" "    $d/d/abcdé.\n    $d/d/abc\342\205\240d.\n    $d/d/abc\360\237\231\202.\n    $d/d/abc\370d.\n    $d/d/abc\370\342\205\240.\n"                "" 0 "-L '%22.18p\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%22.19p.\n'     $d/d" "    $d/d/abc\370\342\205\240.\n   $d/d/abcdéf.\n   $d/d/abc\342\205\240de.\n   $d/d/abc\360\237\231\202d.\n   $d/d/abc\370de.\n"                "" 0 "-L '%22.19p\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%22.20p.\n'     $d/d" "   $d/d/abcdéf.\n  $d/d/abc\342\205\240def.\n  $d/d/abc\360\237\231\202de.\n  $d/d/abc\370def.\n  $d/d/abc\370\342\205\240\360\237\231\202.\n"  "" 0 "-L '%22.20p\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%22.21p.\n'     $d/d" "   $d/d/abcdéf.\n  $d/d/abc\342\205\240def.\n  $d/d/abc\370def.\n $d/d/abc\360\237\231\202def.\n $d/d/abc\370\342\205\240\360\237\231\202d.\n"  "" 0 "-L '%22.21p\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%22.22p.\n'     $d/d" "   $d/d/abcdéf.\n  $d/d/abc\342\205\240def.\n  $d/d/abc\370def.\n $d/d/abc\360\237\231\202def.\n$d/d/abc\370\342\205\240\360\237\231\202de.\n"  "" 0 "-L '%22.22p\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%22.23p.\n'     $d/d" "   $d/d/abcdéf.\n  $d/d/abc\342\205\240def.\n  $d/d/abc\370def.\n $d/d/abc\360\237\231\202def.\n$d/d/abc\370\342\205\240\360\237\231\202def.\n" "" 0 "-L '%22.23p\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%22.24p.\n'     $d/d" "   $d/d/abcdéf.\n  $d/d/abc\342\205\240def.\n  $d/d/abc\370def.\n $d/d/abc\360\237\231\202def.\n$d/d/abc\370\342\205\240\360\237\231\202def.\n" "" 0 "-L '%22.24p\\\\n' multi-byte multi-width chars"

			test_rawhide "$rh -m1 -L '%23p.\n'        $d/d" "    $d/d/abcdéf.\n   $d/d/abc\342\205\240def.\n   $d/d/abc\370def.\n  $d/d/abc\360\237\231\202def.\n$d/d/abc\370\342\205\240\360\237\231\202def.\n" "" 0 "-L '%23p\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%-23p.\n'       $d/d" "$d/d/abcdéf    .\n$d/d/abc\342\205\240def   .\n$d/d/abc\360\237\231\202def  .\n$d/d/abc\370def   .\n$d/d/abc\370\342\205\240\360\237\231\202def.\n" "" 0 "-L '%-23p\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%23.0p.\n'      $d/d" "                       .\n                       .\n                       .\n                       .\n                       .\n"                 "" 0 "-L '%23.0p\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%-23.0p.\n'     $d/d" "                       .\n                       .\n                       .\n                       .\n                       .\n"                 "" 0 "-L '%-23.0p\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%23.14p.\n'     $d/d" "         $d/d/a.\n         $d/d/a.\n         $d/d/a.\n         $d/d/a.\n         $d/d/a.\n"                                                         "" 0 "-L '%23.14p\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%23.15p.\n'     $d/d" "        $d/d/ab.\n        $d/d/ab.\n        $d/d/ab.\n        $d/d/ab.\n        $d/d/ab.\n"                                                         "" 0 "-L '%23.15p\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%23.16p.\n'     $d/d" "       $d/d/abc.\n       $d/d/abc.\n       $d/d/abc.\n       $d/d/abc.\n       $d/d/abc.\n"                                                         "" 0 "-L '%23.16p\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%23.17p.\n'     $d/d" "       $d/d/abc.\n      $d/d/abcd.\n      $d/d/abc$(printf '\342\205\240').\n      $d/d/abc$(printf '\370').\n      $d/d/abc$(printf '\370').\n"    "" 0 "-L '%23.17p\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%23.18p.\n'     $d/d" "     $d/d/abcdé.\n     $d/d/abc\342\205\240d.\n     $d/d/abc\360\237\231\202.\n     $d/d/abc\370d.\n     $d/d/abc\370\342\205\240.\n"               "" 0 "-L '%23.18p\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%23.19p.\n'     $d/d" "     $d/d/abc\370\342\205\240.\n    $d/d/abcdéf.\n    $d/d/abc\342\205\240de.\n    $d/d/abc\360\237\231\202d.\n    $d/d/abc\370de.\n"               "" 0 "-L '%23.19p\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%23.20p.\n'     $d/d" "    $d/d/abcdéf.\n   $d/d/abc\342\205\240def.\n   $d/d/abc\360\237\231\202de.\n   $d/d/abc\370def.\n   $d/d/abc\370\342\205\240\360\237\231\202.\n" "" 0 "-L '%23.20p\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%23.21p.\n'     $d/d" "    $d/d/abcdéf.\n   $d/d/abc\342\205\240def.\n   $d/d/abc\370def.\n  $d/d/abc\360\237\231\202def.\n  $d/d/abc\370\342\205\240\360\237\231\202d.\n" "" 0 "-L '%23.21p\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%23.22p.\n'     $d/d" "    $d/d/abcdéf.\n   $d/d/abc\342\205\240def.\n   $d/d/abc\370def.\n  $d/d/abc\360\237\231\202def.\n $d/d/abc\370\342\205\240\360\237\231\202de.\n" "" 0 "-L '%23.22p\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%23.23p.\n'     $d/d" "    $d/d/abcdéf.\n   $d/d/abc\342\205\240def.\n   $d/d/abc\370def.\n  $d/d/abc\360\237\231\202def.\n$d/d/abc\370\342\205\240\360\237\231\202def.\n" "" 0 "-L '%23.23p\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%23.24p.\n'     $d/d" "    $d/d/abcdéf.\n   $d/d/abc\342\205\240def.\n   $d/d/abc\370def.\n  $d/d/abc\360\237\231\202def.\n$d/d/abc\370\342\205\240\360\237\231\202def.\n" "" 0 "-L '%23.24p\\\\n' multi-byte multi-width chars"

			test_rawhide "$rh -m1 -L '%24p.\n'        $d/d" "     $d/d/abcdéf.\n    $d/d/abc\342\205\240def.\n    $d/d/abc\370def.\n   $d/d/abc\360\237\231\202def.\n $d/d/abc\370\342\205\240\360\237\231\202def.\n" "" 0 "-L '%24p\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%-24p.\n'       $d/d" "$d/d/abcdéf     .\n$d/d/abc\342\205\240def    .\n$d/d/abc\360\237\231\202def   .\n$d/d/abc\370def    .\n$d/d/abc\370\342\205\240\360\237\231\202def .\n" "" 0 "-L '%-24p\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%24.0p.\n'      $d/d" "                        .\n                        .\n                        .\n                        .\n                        .\n"                 "" 0 "-L '%24.0p\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%-24.0p.\n'     $d/d" "                        .\n                        .\n                        .\n                        .\n                        .\n"                 "" 0 "-L '%-24.0p\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%24.14p.\n'     $d/d" "          $d/d/a.\n          $d/d/a.\n          $d/d/a.\n          $d/d/a.\n          $d/d/a.\n"                                                         "" 0 "-L '%24.14p\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%24.15p.\n'     $d/d" "         $d/d/ab.\n         $d/d/ab.\n         $d/d/ab.\n         $d/d/ab.\n         $d/d/ab.\n"                                                         "" 0 "-L '%24.15p\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%24.16p.\n'     $d/d" "        $d/d/abc.\n        $d/d/abc.\n        $d/d/abc.\n        $d/d/abc.\n        $d/d/abc.\n"                                                         "" 0 "-L '%24.16p\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%24.17p.\n'     $d/d" "        $d/d/abc.\n       $d/d/abcd.\n       $d/d/abc$(printf '\342\205\240').\n       $d/d/abc$(printf '\370').\n       $d/d/abc$(printf '\370').\n"    "" 0 "-L '%24.17p\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%24.18p.\n'     $d/d" "      $d/d/abcdé.\n      $d/d/abc\342\205\240d.\n      $d/d/abc\360\237\231\202.\n      $d/d/abc\370d.\n      $d/d/abc\370\342\205\240.\n"               "" 0 "-L '%24.18p\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%24.19p.\n'     $d/d" "      $d/d/abc\370\342\205\240.\n     $d/d/abcdéf.\n     $d/d/abc\342\205\240de.\n     $d/d/abc\360\237\231\202d.\n     $d/d/abc\370de.\n"               "" 0 "-L '%24.19p\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%24.20p.\n'     $d/d" "     $d/d/abcdéf.\n    $d/d/abc\342\205\240def.\n    $d/d/abc\360\237\231\202de.\n    $d/d/abc\370def.\n    $d/d/abc\370\342\205\240\360\237\231\202.\n" "" 0 "-L '%24.20p\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%24.21p.\n'     $d/d" "     $d/d/abcdéf.\n    $d/d/abc\342\205\240def.\n    $d/d/abc\370def.\n   $d/d/abc\360\237\231\202def.\n   $d/d/abc\370\342\205\240\360\237\231\202d.\n" "" 0 "-L '%24.21p\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%24.22p.\n'     $d/d" "     $d/d/abcdéf.\n    $d/d/abc\342\205\240def.\n    $d/d/abc\370def.\n   $d/d/abc\360\237\231\202def.\n  $d/d/abc\370\342\205\240\360\237\231\202de.\n" "" 0 "-L '%24.22p\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%24.23p.\n'     $d/d" "     $d/d/abcdéf.\n    $d/d/abc\342\205\240def.\n    $d/d/abc\370def.\n   $d/d/abc\360\237\231\202def.\n $d/d/abc\370\342\205\240\360\237\231\202def.\n" "" 0 "-L '%24.23p\\\\n' multi-byte multi-width chars"
			test_rawhide "$rh -m1 -L '%24.24p.\n'     $d/d" "     $d/d/abcdéf.\n    $d/d/abc\342\205\240def.\n    $d/d/abc\370def.\n   $d/d/abc\360\237\231\202def.\n $d/d/abc\370\342\205\240\360\237\231\202def.\n" "" 0 "-L '%24.24p\\\\n' multi-byte multi-width chars"

			test_rawhide_post_hook() { true; }
			rm -r $d/d
			;;
	esac
fi

grpch="[a-zA-Z0-9._-]"
grp="$grpch+"
test_rawhide_grep "$rh -L '%g\n'        $d/f" "^$grp\$"                                    ""                                         0 "-L '%g\\\\n' (ok to fail with bizarre group name)"
test_rawhide_grep "$rh -L '%25g\n'      $d/f" "^ +$grp\$"                                  ""                                         0 "-L '%25g\\\\n'"
test_rawhide_grep "$rh -L '%-25g\n'     $d/f" "^$grp +\$"                                  ""                                         0 "-L '%-25g\\\\n'"
test_rawhide_grep "$rh -L '%25.2g\n'    $d/f" "^                       $grpch$grpch\$"     ""                                         0 "-L '%25.2g\\\\n'"
test_rawhide_grep "$rh -L '%-25.2g\n'   $d/f" "^$grpch$grpch                       \$"     ""                                         0 "-L '%-25.2g\\\\n'"

if [ "`whoami`" = root ]
then
	touch $d/u
	chown 61524 $d/u
	chgrp 61524 $d/u
	test_rawhide_grep "$rh -L '%g\n'    $d/u" "^61524\$"                                   ""                                         0 "-L '%g\\\\n' (with unknown/numeric group 61524)"
	test_rawhide_grep "$rh -L '%u\n'    $d/u" "^61524\$"                                   ""                                         0 "-L '%u\\\\n' (with unknown/numeric user 61524)"
	rm $d/u
fi

num="[0-9]+"
test_rawhide_grep "$rh -L '%G\n'        $d/f" "^$num\$"                                    ""                                         0 "-L '%G\\\\n'"
test_rawhide_grep "$rh -L '%25G\n'      $d/f" "^ +$num\$"                                  ""                                         0 "-L '%25G\\\\n'"
test_rawhide_grep "$rh -L '%025G\n'     $d/f" "^0$num\$"                                   ""                                         0 "-L '%025G\\\\n'"
test_rawhide_grep "$rh -L '% 25G\n'     $d/f" "^ +$num\$"                                  ""                                         0 "-L '% 25G\\\\n'"
test_rawhide_grep "$rh -L '%+25G\n'     $d/f" "^ +\+$num\$"                                ""                                         0 "-L '%+25G\\\\n'"
test_rawhide_grep "$rh -L '%-25G\n'     $d/f" "^$num +\$"                                  ""                                         0 "-L '%-25G\\\\n'"
test_rawhide_grep "$rh -L '%#25G\n'     $d/f" "^ +$num\$"                                  ""                                         0 "-L '%#25G\\\\n'"
test_rawhide_grep "$rh -L '%.5G\n'      $d/f" "^$num\$"                                    ""                                         0 "-L '%.5G\\\\n'"
test_rawhide_grep "$rh -L '%25.5G\n'    $d/f" "^ +$num\$"                                  ""                                         0 "-L '%25.5G\\\\n'"
test_rawhide_grep "$rh -L '%-25.5G\n'   $d/f" "^$num +\$"                                  ""                                         0 "-L '%-25.5G\\\\n'"

test_rawhide "$rh -L '%h\n'             $d/f" "$d\n"                                       ""                                         0 "-L '%h\\\\n'"
test_rawhide "$rh -L '%15h\n'           $d/f" "     $d\n"                                  ""                                         0 "-L '%15h\\\\n'"
test_rawhide "$rh -L '%-15h\n'          $d/f" "$d     \n"                                  ""                                         0 "-L '%-15h\\\\n'"
test_rawhide "$rh -L '%15.5h\n'         $d/f" "          tests\n"                          ""                                         0 "-L '%15.5h\\\\n'"
test_rawhide "$rh -L '%-15.5h\n'        $d/f" "tests          \n"                          ""                                         0 "-L '%-15.5h\\\\n'"

test_rawhide "$rh -L '%h\n'             $d"   "tests\n$d\n$d\n"                            ""                                         0 "-L '%h\\\\n'"
test_rawhide "$rh -L '%h\n' -M0 tests"        ".\n"                                        ""                                         0 "-L '%h\\\\n' tests"
test_rawhide "$rh -L '%h\n' -M0 /"            "\n"                                         ""                                         0 "-L '%h\\\\n' /"
test_rawhide "$rh -L '%h\n' -M0 /etc"         "\n"                                         ""                                         0 "-L '%h\\\\n' /etc"

test_rawhide "$rh -L '%H\n'             $d"   "$d\n$d\n$d\n"                               ""                                         0 "-L '%H\\\\n'"
test_rawhide "$rh -L '%H\n'             $d/f" "$d/f\n"                                     ""                                         0 "-L '%H\\\\n'"
test_rawhide "$rh -L '%15H\n'           $d/f" "   $d/f\n"                                  ""                                         0 "-L '%15H\\\\n'"
test_rawhide "$rh -L '%-15H\n'          $d/f" "$d/f   \n"                                  ""                                         0 "-L '%-15H\\\\n'"
test_rawhide "$rh -L '%15.5H\n'         $d/f" "          tests\n"                          ""                                         0 "-L '%15.5H\\\\n'"
test_rawhide "$rh -L '%-15.5H\n'        $d/f" "tests          \n"                          ""                                         0 "-L '%-15.5H\\\\n'"

test_rawhide_grep "$rh -L '%i\n'        $d/f" "^$num\$"                                    ""                                         0 "-L '%i\\\\n'"
test_rawhide_grep "$rh -L '%25i\n'      $d/f" "^ +$num\$"                                  ""                                         0 "-L '%25i\\\\n'"
test_rawhide_grep "$rh -L '%025i\n'     $d/f" "^0$num\$"                                   ""                                         0 "-L '%025i\\\\n'"
test_rawhide_grep "$rh -L '% 25i\n'     $d/f" "^ +$num\$"                                  ""                                         0 "-L '% 25i\\\\n'"
test_rawhide_grep "$rh -L '%+25i\n'     $d/f" "^ +\+$num\$"                                ""                                         0 "-L '%+25i\\\\n'"
test_rawhide_grep "$rh -L '%-25i\n'     $d/f" "^$num +\$"                                  ""                                         0 "-L '%-25i\\\\n'"
test_rawhide_grep "$rh -L '%#25i\n'     $d/f" "^ +$num\$"                                  ""                                         0 "-L '%#25i\\\\n'"
test_rawhide_grep "$rh -L '%.5i\n'      $d/f" "^$num\$"                                    ""                                         0 "-L '%.5i\\\\n'"
test_rawhide_grep "$rh -L '%25.5i\n'    $d/f" "^ +$num\$"                                  ""                                         0 "-L '%25.5i\\\\n'"
test_rawhide_grep "$rh -L '%-25.5i\n'   $d/f" "^$num +\$"                                  ""                                         0 "-L '%-25.5i\\\\n'"

test_rawhide_grep "$rh -L '%k\n'        $d/f" "^$num\$"                                    ""                                         0 "-L '%k\\\\n'"
test_rawhide_grep "$rh -L '%25k\n'      $d/f" "^ +$num\$"                                  ""                                         0 "-L '%25k\\\\n'"
test_rawhide_grep "$rh -L '%025k\n'     $d/f" "^0$num\$"                                   ""                                         0 "-L '%025k\\\\n'"
test_rawhide_grep "$rh -L '% 25k\n'     $d/f" "^ +$num\$"                                  ""                                         0 "-L '% 25k\\\\n'"
test_rawhide_grep "$rh -L '%+25k\n'     $d/f" "^ +\+$num\$"                                ""                                         0 "-L '%+25k\\\\n'"
test_rawhide_grep "$rh -L '%-25k\n'     $d/f" "^$num +\$"                                  ""                                         0 "-L '%-25k\\\\n'"
test_rawhide_grep "$rh -L '%#25k\n'     $d/f" "^ +$num\$"                                  ""                                         0 "-L '%#25k\\\\n'"
test_rawhide_grep "$rh -L '%.5k\n'      $d/f" "^$num\$"                                    ""                                         0 "-L '%.5k\\\\n'"
test_rawhide_grep "$rh -L '%25.5k\n'    $d/f" "^ +$num\$"                                  ""                                         0 "-L '%25.5k\\\\n'"
test_rawhide_grep "$rh -L '%-25.5k\n'   $d/f" "^$num +\$"                                  ""                                         0 "-L '%-25.5k\\\\n'"

test_rawhide "$rh -L '%l\n'             $d/f" "\n"                                         ""                                         0 "-L '%l\\\\n'"
test_rawhide "$rh -L '%l\n'             $d/l" "f\n"                                        ""                                         0 "-L '%l\\\\n'"
test_rawhide "$rh -L '%15l\n'           $d/l" "              f\n"                          ""                                         0 "-L '%15l\\\\n'"
test_rawhide "$rh -L '%-15l\n'          $d/l" "f              \n"                          ""                                         0 "-L '%-15l\\\\n'"
test_rawhide "$rh -L '%15.0l\n'         $d/l" "               \n"                          ""                                         0 "-L '%15.5l\\\\n'"
test_rawhide "$rh -L '%-15.0l\n'        $d/l" "               \n"                          ""                                         0 "-L '%-15.5l\\\\n'"

test_rawhide "$rh -L '%m\n'             $d/f" "644\n"                                      ""                                         0 "-L '%m\\\\n' $d/f"
test_rawhide "$rh -L '%10m\n'           $d/f" "       644\n"                               ""                                         0 "-L '%10m\\\\n' $d/f"
test_rawhide "$rh -L '%010m\n'          $d/f" "0000000644\n"                               ""                                         0 "-L '%010m\\\\n' $d/f"
test_rawhide "$rh -L '% 10m\n'          $d/f" "       644\n"                               ""                                         0 "-L '% 10m\\\\n' $d/f"
test_rawhide "$rh -L '%+10m\n'          $d/f" "       644\n"                               ""                                         0 "-L '%+10m\\\\n' $d/f (shouldn't there be a plus here? maybe not when octal)"
test_rawhide "$rh -L '%-10m\n'          $d/f" "644       \n"                               ""                                         0 "-L '%-10m\\\\n' $d/f"
test_rawhide "$rh -L '%#10m\n'          $d/f" "      0644\n"                               ""                                         0 "-L '%#10m\\\\n' $d/f"
test_rawhide "$rh -L '%.5m\n'           $d/f" "00644\n"                                    ""                                         0 "-L '%.5m\\\\n' $d/f"
test_rawhide "$rh -L '%10.5m\n'         $d/f" "     00644\n"                               ""                                         0 "-L '%10.5m\\\\n' $d/f"
test_rawhide "$rh -L '%-10.5m\n'        $d/f" "00644     \n"                               ""                                         0 "-L '%-10.5m\\\\n' $d/f"

case "`uname`" in
	Darwin|FreeBSD|OpenBSD|NetBSD)
		test_rawhide "$rh -L '%m\n'             $d/l" "755\n"                                      ""                                         0 "-L '%m\\\\n' $d/l"
		test_rawhide "$rh -L '%10m\n'           $d/l" "       755\n"                               ""                                         0 "-L '%10m\\\\n' $d/l"
		test_rawhide "$rh -L '%010m\n'          $d/l" "0000000755\n"                               ""                                         0 "-L '%010m\\\\n' $d/l"
		test_rawhide "$rh -L '% 10m\n'          $d/l" "       755\n"                               ""                                         0 "-L '% 10m\\\\n' $d/l"
		test_rawhide "$rh -L '%+10m\n'          $d/l" "       755\n"                               ""                                         0 "-L '%+10m\\\\n' $d/l (shouldn't there be a plus here? maybe not when octal)"
		test_rawhide "$rh -L '%-10m\n'          $d/l" "755       \n"                               ""                                         0 "-L '%-10m\\\\n' $d/l"
		test_rawhide "$rh -L '%#10m\n'          $d/l" "      0755\n"                               ""                                         0 "-L '%#10m\\\\n' $d/l"
		test_rawhide "$rh -L '%.5m\n'           $d/l" "00755\n"                                    ""                                         0 "-L '%.5m\\\\n' $d/l"
		test_rawhide "$rh -L '%10.5m\n'         $d/l" "     00755\n"                               ""                                         0 "-L '%10.5m\\\\n' $d/l"
		test_rawhide "$rh -L '%-10.5m\n'        $d/l" "00755     \n"                               ""                                         0 "-L '%-10.5m\\\\n' $d/l"
		;;
	*)
		test_rawhide "$rh -L '%m\n'             $d/l" "777\n"                                      ""                                         0 "-L '%m\\\\n' $d/l"
		test_rawhide "$rh -L '%10m\n'           $d/l" "       777\n"                               ""                                         0 "-L '%10m\\\\n' $d/l"
		test_rawhide "$rh -L '%010m\n'          $d/l" "0000000777\n"                               ""                                         0 "-L '%010m\\\\n' $d/l"
		test_rawhide "$rh -L '% 10m\n'          $d/l" "       777\n"                               ""                                         0 "-L '% 10m\\\\n' $d/l"
		test_rawhide "$rh -L '%+10m\n'          $d/l" "       777\n"                               ""                                         0 "-L '%+10m\\\\n' $d/l (shouldn't there be a plus here? maybe not when octal)"
		test_rawhide "$rh -L '%-10m\n'          $d/l" "777       \n"                               ""                                         0 "-L '%-10m\\\\n' $d/l"
		test_rawhide "$rh -L '%#10m\n'          $d/l" "      0777\n"                               ""                                         0 "-L '%#10m\\\\n' $d/l"
		test_rawhide "$rh -L '%.5m\n'           $d/l" "00777\n"                                    ""                                         0 "-L '%.5m\\\\n' $d/l"
		test_rawhide "$rh -L '%10.5m\n'         $d/l" "     00777\n"                               ""                                         0 "-L '%10.5m\\\\n' $d/l"
		test_rawhide "$rh -L '%-10.5m\n'        $d/l" "00777     \n"                               ""                                         0 "-L '%-10.5m\\\\n' $d/l"
		;;
esac

test_rawhide "$rh -L ' %M\n'            $d/f" " -rw-r--r--\n"                              ""                                         0 "-L '%M\\\\n' $d/f"
test_rawhide "$rh -L ' %15M\n'          $d/f" "      -rw-r--r--\n"                         ""                                         0 "-L '%15M\\\\n' $d/f"
test_rawhide "$rh -L ' %-15M\n'         $d/f" " -rw-r--r--     \n"                         ""                                         0 "-L '%-15M\\\\n' $d/f"
test_rawhide "$rh -L ' %15.5M\n'        $d/f" "           -rw-r\n"                         ""                                         0 "-L '%15.5M\\\\n' $d/f"
test_rawhide "$rh -L ' %-15.5M\n'       $d/f" " -rw-r          \n"                         ""                                         0 "-L '%-15.5M\\\\n' $d/f"

case "`uname`" in
	Darwin|FreeBSD|OpenBSD|NetBSD)
		test_rawhide "$rh -L ' %M\n'            $d/l" " lrwxr-xr-x\n"                              ""                                         0 "-L '%M\\\\n' $d/l"
		test_rawhide "$rh -L ' %15M\n'          $d/l" "      lrwxr-xr-x\n"                         ""                                         0 "-L '%15M\\\\n' $d/l"
		test_rawhide "$rh -L ' %-15M\n'         $d/l" " lrwxr-xr-x     \n"                         ""                                         0 "-L '%-15M\\\\n' $d/l"
		test_rawhide "$rh -L ' %15.5M\n'        $d/l" "           lrwxr\n"                         ""                                         0 "-L '%15.5M\\\\n' $d/l"
		test_rawhide "$rh -L ' %-15.5M\n'       $d/l" " lrwxr          \n"                         ""                                         0 "-L '%-15.5M\\\\n' $d/l"
		;;
	*)
		test_rawhide "$rh -L ' %M\n'            $d/l" " lrwxrwxrwx\n"                              ""                                         0 "-L '%M\\\\n' $d/l"
		test_rawhide "$rh -L ' %15M\n'          $d/l" "      lrwxrwxrwx\n"                         ""                                         0 "-L '%15M\\\\n' $d/l"
		test_rawhide "$rh -L ' %-15M\n'         $d/l" " lrwxrwxrwx     \n"                         ""                                         0 "-L '%-15M\\\\n' $d/l"
		test_rawhide "$rh -L ' %15.5M\n'        $d/l" "           lrwxr\n"                         ""                                         0 "-L '%15.5M\\\\n' $d/l"
		test_rawhide "$rh -L ' %-15.5M\n'       $d/l" " lrwxr          \n"                         ""                                         0 "-L '%-15.5M\\\\n' $d/l"
		;;
esac

test_rawhide "$rh -L '%n\n'             $d/l" "1\n"                                        ""                                         0 "-L '%n\\\\n'"
test_rawhide "$rh -L '%25n\n'           $d/f" "                        1\n"                ""                                         0 "-L '%25n\\\\n'"
test_rawhide "$rh -L '%025n\n'          $d/f" "0000000000000000000000001\n"                ""                                         0 "-L '%025n\\\\n'"
test_rawhide "$rh -L '% 25n\n'          $d/f" "                        1\n"                ""                                         0 "-L '% 25n\\\\n'"
test_rawhide "$rh -L '%+25n\n'          $d/f" "                       +1\n"                ""                                         0 "-L '%+25n\\\\n'"
test_rawhide "$rh -L '%-25n\n'          $d/f" "1                        \n"                ""                                         0 "-L '%-25n\\\\n'"
test_rawhide "$rh -L '%#25n\n'          $d/f" "                        1\n"                ""                                         0 "-L '%#25n\\\\n'"
test_rawhide "$rh -L '%.5n\n'           $d/f" "00001\n"                                    ""                                         0 "-L '%.5n\\\\n'"
test_rawhide "$rh -L '%25.5n\n'         $d/f" "                    00001\n"                ""                                         0 "-L '%25.5n\\\\n'"
test_rawhide "$rh -L '%-25.5n\n'        $d/f" "00001                    \n"                ""                                         0 "-L '%-25.5n\\\\n'"
rm $d/l

test_rawhide "$rh -L '%p\n'             $d" "$d\n$d/f\n"                                   ""                                         0 "-L '%p\\\\n'"
test_rawhide "$rh -L '%15p\n'           $d" "     $d\n   $d/f\n"                           ""                                         0 "-L '%15p\\\\n'"
test_rawhide "$rh -L '%-15p\n'          $d" "$d     \n$d/f   \n"                           ""                                         0 "-L '%-15p\\\\n'"
test_rawhide "$rh -L '%15.5p\n'         $d" "          tests\n          tests\n"           ""                                         0 "-L '%15.5p\\\\n'"
test_rawhide "$rh -L '%-15.5p\n'        $d" "tests          \ntests          \n"           ""                                         0 "-L '%-15.5p\\\\n'"

test_rawhide "$rh -L '%P\n'             $d" "\nf\n"                                        ""                                         0 "-L '%P\\\\n'"
test_rawhide "$rh -L '%15P\n'           $d" "               \n              f\n"           ""                                         0 "-L '%15P\\\\n'"
test_rawhide "$rh -L '%-15P\n'          $d" "               \nf              \n"           ""                                         0 "-L '%-15P\\\\n'"
test_rawhide "$rh -L '%15.0P\n'         $d" "               \n               \n"           ""                                         0 "-L '%15.0P\\\\n'"
test_rawhide "$rh -L '%-15.0P\n'        $d" "               \n               \n"           ""                                         0 "-L '%-15.0P\\\\n'"

test_rawhide_grep "$rh -L '%r\n'        /dev/null"                     "^[0-9]+\$"         ""                                         0 "-L '%r\\\\n'"
test_rawhide_grep "$rh -L '%25r\n'      /dev/null"                     "^ +[0-9]+\$"       ""                                         0 "-L '%25r\\\\n'"
test_rawhide_grep "$rh -L '%025r\n'     /dev/null"                     "^0[0-9]+\$"        ""                                         0 "-L '%025r\\\\n'"
test_rawhide_grep "$rh -L '% 25r\n'     /dev/null"                     "^ +[0-9]+\$"       ""                                         0 "-L '% 25r\\\\n'"
test_rawhide_grep "$rh -L '%+25r\n'     /dev/null"                     "^ +\+[0-9]+\$"     ""                                         0 "-L '%+25r\\\\n'"
test_rawhide_grep "$rh -L '%-25r\n'     /dev/null"                     "^[0-9]+ +\$"       ""                                         0 "-L '%-25r\\\\n'"
test_rawhide_grep "$rh -L '%#25r\n'     /dev/null"                     "^ +[0-9]+\$"       ""                                         0 "-L '%#25r\\\\n'"
test_rawhide_grep "$rh -L '%.5r\n'      /dev/null"                     "^[0-9]+\$"         ""                                         0 "-L '%.5r\\\\n'"
test_rawhide_grep "$rh -L '%25.5r\n'    /dev/null"                     "^ +[0-9]+\$"       ""                                         0 "-L '%25.5r\\\\n'"
test_rawhide_grep "$rh -L '%-25.5r\n'   /dev/null"                     "^[0-9]+ +\$"       ""                                         0 "-L '%-25.5r\\\\n'"

test_rawhide_grep "$rh -L '%R\n'        /dev/null"                     "^[0-9]+\$"         ""                                         0 "-L '%R\\\\n'"
test_rawhide_grep "$rh -L '%25R\n'      /dev/null"                     "^ +[0-9]+\$"       ""                                         0 "-L '%25R\\\\n'"
test_rawhide_grep "$rh -L '%025R\n'     /dev/null"                     "^0[0-9]+\$"        ""                                         0 "-L '%025R\\\\n'"
test_rawhide_grep "$rh -L '% 25R\n'     /dev/null"                     "^ +[0-9]+\$"       ""                                         0 "-L '% 25R\\\\n'"
test_rawhide_grep "$rh -L '%+25R\n'     /dev/null"                     "^ +\+[0-9]+\$"     ""                                         0 "-L '%+25R\\\\n'"
test_rawhide_grep "$rh -L '%-25R\n'     /dev/null"                     "^[0-9]+ +\$"       ""                                         0 "-L '%-25R\\\\n'"
test_rawhide_grep "$rh -L '%#25R\n'     /dev/null"                     "^ +[0-9]+\$"       ""                                         0 "-L '%#25R\\\\n'"
test_rawhide_grep "$rh -L '%.5R\n'      /dev/null"                     "^[0-9]+\$"         ""                                         0 "-L '%.5R\\\\n'"
test_rawhide_grep "$rh -L '%25.5R\n'    /dev/null"                     "^ +[0-9]+\$"       ""                                         0 "-L '%25.5R\\\\n'"
test_rawhide_grep "$rh -L '%-25.5R\n'   /dev/null"                     "^[0-9]+ +\$"       ""                                         0 "-L '%-25.5R\\\\n'"

test_rawhide "$rh -L '%s\n'             $d/f" "0\n"                                        ""                                         0 "-L '%s\\\\n'"
test_rawhide "$rh -L '%25s\n'           $d/f" "                        0\n"                ""                                         0 "-L '%25s\\\\n'"
test_rawhide "$rh -L '%025s\n'          $d/f" "0000000000000000000000000\n"                ""                                         0 "-L '%025s\\\\n'"
test_rawhide "$rh -L '% 25s\n'          $d/f" "                        0\n"                ""                                         0 "-L '% 25s\\\\n'"
test_rawhide "$rh -L '%+25s\n'          $d/f" "                       +0\n"                ""                                         0 "-L '%+25s\\\\n'"
test_rawhide "$rh -L '%-25s\n'          $d/f" "0                        \n"                ""                                         0 "-L '%-25s\\\\n'"
test_rawhide "$rh -L '%#25s\n'          $d/f" "                        0\n"                ""                                         0 "-L '%#25s\\\\n'"
test_rawhide "$rh -L '%.5s\n'           $d/f" "00000\n"                                    ""                                         0 "-L '%.5s\\\\n'"
test_rawhide "$rh -L '%25.5s\n'         $d/f" "                    00000\n"                ""                                         0 "-L '%25.5s\\\\n'"
test_rawhide "$rh -L '%-25.5s\n'        $d/f" "00000                    \n"                ""                                         0 "-L '%-25.5s\\\\n'"

test_rawhide "$rh -L '%S\n'             $d/f" "1\n"                                        ""                                         0 "-L '%S\\\\n'"
test_rawhide "$rh -L '%25S\n'           $d/f" "                        1\n"                ""                                         0 "-L '%25S\\\\n'"
test_rawhide "$rh -L '%025S\n'          $d/f" "0000000000000000000000001\n"                ""                                         0 "-L '%025S\\\\n'"
test_rawhide "$rh -L '% 25S\n'          $d/f" "                        1\n"                ""                                         0 "-L '% 25S\\\\n'"
test_rawhide "$rh -L '%+25S\n'          $d/f" "                       +1\n"                ""                                         0 "-L '%+25S\\\\n'"
test_rawhide "$rh -L '%-25S\n'          $d/f" "1                        \n"                ""                                         0 "-L '%-25S\\\\n'"
test_rawhide "LANG=C $rh -L '%#25S\n'   $d/f" "                  1.00000\n"                ""                                         0 "-L '%#25S\\\\n'"
test_rawhide "$rh -L '%.5S\n'           $d/f" "1\n"                                        ""                                         0 "-L '%.5S\\\\n'"
test_rawhide "$rh -L '%25.5S\n'         $d/f" "                        1\n"                ""                                         0 "-L '%25.5S\\\\n'"
test_rawhide "$rh -L '%-25.5S\n'        $d/f" "1                        \n"                ""                                         0 "-L '%-25.5S\\\\n'"

test_rawhide "LANG=C $rh -L '%t\n'       $d/f" "Sun Feb 18 13:27:32 1990\n"                 ""                                               0 "-L '%t\\\\n'"
test_rawhide "LANG=C $rh -L '%25t\n'     $d/f" " Sun Feb 18 13:27:32 1990\n"                ""                                               0 "-L '%25t\\\\n'"
test_rawhide "LANG=C $rh -L '%-25t\n'    $d/f" "Sun Feb 18 13:27:32 1990 \n"                ""                                               0 "-L '%-25t\\\\n'"
test_rawhide "LANG=C $rh -L '%.15t\n'    $d/f" "Sun Feb 18 13:2\n"                          ""                                               0 "-L '%.15t\\\\n'"
test_rawhide "LANG=C $rh -L '%25.15t\n'  $d/f" "          Sun Feb 18 13:2\n"                ""                                               0 "-L '%25.15t\\\\n'"
test_rawhide "LANG=C $rh -L '%-25.15t\n' $d/f" "Sun Feb 18 13:2          \n"                ""                                               0 "-L '%-25.15t\\\\n'"

test_rawhide "$rh -L '%T'               $d/f" ""                                           "./rh: invalid %%T conversion: %%T\n"            1 "-L '%T' (invalid)"
test_rawhide "$rh -L '%T?'              $d/f" ""                                           "./rh: invalid %%T conversion: %%T?\n"           1 "-L '%T?' (invalid)"
test_rawhide "$rh -L '%25T'             $d/f" ""                                           "./rh: invalid %%T conversion: %%25T\n"          1 "-L '%25T' (invalid)"
test_rawhide "$rh -L '%-25T'            $d/f" ""                                           "./rh: invalid %%T conversion: %%-25T\n"         1 "-L '%-25T' (invalid)"
test_rawhide "$rh -L '%.15T'            $d/f" ""                                           "./rh: invalid %%T conversion: %%.15T\n"         1 "-L '%.15T' (invalid)"
test_rawhide "$rh -L '%25.15T'          $d/f" ""                                           "./rh: invalid %%T conversion: %%25.15T\n"       1 "-L '%25.15T' (invalid)"
test_rawhide "$rh -L '%-25.15T'         $d/f" ""                                           "./rh: invalid %%T conversion: %%-25.15T\n"      1 "-L '%-25.15T' (invalid)"

test_rawhide "$rh -L '%T\n'             $d/f" ""                                           "./rh: invalid %%T conversion: %%T\\\\n\n"       1 "-L '%T\\\\n' (invalid)"
test_rawhide "$rh -L '%25T\n'           $d/f" ""                                           "./rh: invalid %%T conversion: %%25T\\\\n\n"     1 "-L '%25T\\\\n' (invalid)"
test_rawhide "$rh -L '%-25T\n'          $d/f" ""                                           "./rh: invalid %%T conversion: %%-25T\\\\n\n"    1 "-L '%-25T\\\\n' (invalid)"
test_rawhide "$rh -L '%.15T\n'          $d/f" ""                                           "./rh: invalid %%T conversion: %%.15T\\\\n\n"    1 "-L '%.15T\\\\n' (invalid)"
test_rawhide "$rh -L '%25.15T\n'        $d/f" ""                                           "./rh: invalid %%T conversion: %%25.15T\\\\n\n"  1 "-L '%25.15T\\\\n' (invalid)"
test_rawhide "$rh -L '%-25.15T\n'       $d/f" ""                                           "./rh: invalid %%T conversion: %%-25.15T\\\\n\n" 1 "-L '%-25.15T\\\\n' (invalid)"

test_rawhide "$rh -L '%T@\n'            $d/f" "635347652.000000000\n"                      ""                                         0 "-L '%T@\\\\n'"
test_rawhide "$rh -L '%25T@\n'          $d/f" "      635347652.000000000\n"                ""                                         0 "-L '%25T@\\\\n'"
test_rawhide "$rh -L '%025T@\n'         $d/f" "000000635347652.000000000\n"                ""                                         0 "-L '%025T@\\\\n'"
test_rawhide "$rh -L '% 25T@\n'         $d/f" "      635347652.000000000\n"                ""                                         0 "-L '% 25T@\\\\n'"
test_rawhide "$rh -L '%+25T@\n'         $d/f" "     +635347652.000000000\n"                ""                                         0 "-L '%+25T@\\\\n'"
test_rawhide "$rh -L '%-25T@\n'         $d/f" "635347652.000000000      \n"                ""                                         0 "-L '%-25T@\\\\n'"
test_rawhide "$rh -L '%#25T@\n'         $d/f" "      635347652.000000000\n"                ""                                         0 "-L '%#25T@\\\\n'"
test_rawhide "$rh -L '%.15T@\n'         $d/f" "635347652.000000000000000\n"                ""                                         0 "-L '%.15T@\\\\n'"
test_rawhide "$rh -L '%35.15T@\n'       $d/f" "          635347652.000000000000000\n"      ""                                         0 "-L '%35.15T@\\\\n'"
test_rawhide "$rh -L '%-35.15T@\n'      $d/f" "635347652.000000000000000          \n"      ""                                         0 "-L '%-35.15T@\\\\n'"

test_rawhide "$rh -L '%25.5T@\n'   $d/f" "          635347652.00000\n" ""                                     0 "-L '%25.5T@\\\\n'"
test_rawhide "$rh -L '%-25.5T@\n'  $d/f" "635347652.00000          \n" ""                                     0 "-L '%-25.5T@\\\\n'"
test_rawhide "$rh -L '%25.1T@\n'   $d/f" "              635347652.0\n" ""                                     0 "-L '%25.1T@\\\\n'"
test_rawhide "$rh -L '%-25.1T@\n'  $d/f" "635347652.0              \n" ""                                     0 "-L '%-25.1T@\\\\n'"
test_rawhide "$rh -L '%25.0T@\n'   $d/f" "                635347652\n" ""                                     0 "-L '%25.0T@\\\\n'"
test_rawhide "$rh -L '%-25.0T@\n'  $d/f" "635347652                \n" ""                                     0 "-L '%-25.0T@\\\\n'"
test_rawhide "$rh -L '%#25.0T@\n'  $d/f" "               635347652.\n" ""                                     0 "-L '%#25.0T@\\\\n'"
test_rawhide "$rh -L '%#-25.0T@\n' $d/f" "635347652.               \n" ""                                     0 "-L '%#-25.0T@\\\\n'"
test_rawhide "$rh -L '%25.T@\n'    $d/f" "                635347652\n" ""                                     0 "-L '%25.T@\\\\n'"
test_rawhide "$rh -L '%-25.T@\n'   $d/f" "635347652                \n" ""                                     0 "-L '%-25.T@\\\\n'"
test_rawhide "$rh -L '%#25.T@\n'   $d/f" "               635347652.\n" ""                                     0 "-L '%#25.T@\\\\n'"
test_rawhide "$rh -L '%#-25.T@\n'  $d/f" "635347652.               \n" ""                                     0 "-L '%#-25.T@\\\\n'"

test_rawhide "$rh -L '%+25T@\n'    $d/f" "     +635347652.000000000\n" ""                                     0 "-L '%+25T@\\\\n'"
test_rawhide "$rh -L '%0+25T@\n'   $d/f" "+00000635347652.000000000\n" ""                                     0 "-L '%0+25T@\\\\n'"
test_rawhide "$rh -L '% 25T@\n'    $d/f" "      635347652.000000000\n" ""                                     0 "-L '% 25T@\\\\n'"
test_rawhide "$rh -L '%0 25T@\n'   $d/f" " 00000635347652.000000000\n" ""                                     0 "-L '%0 25T@\\\\n'"
test_rawhide "$rh -L '%+ 25T@\n'   $d/f" "     +635347652.000000000\n" ""                                     0 "-L '%+ 25T@\\\\n'"
test_rawhide "$rh -L '%0+ 25T@\n'  $d/f" "+00000635347652.000000000\n" ""                                     0 "-L '%0+ 25T@\\\\n'"

touch -t 196002181327.32 $d/f2
test_rawhide "$rh -L '%+25A@\n'    $d/f2" "     -311423548.000000000\n" ""                                     0 "-L '%+25A@\\\\n' negative"
test_rawhide "$rh -L '%0+25A@\n'   $d/f2" "-00000311423548.000000000\n" ""                                     0 "-L '%0+25A@\\\\n' negative"
test_rawhide "$rh -L '% 25A@\n'    $d/f2" "     -311423548.000000000\n" ""                                     0 "-L '% 25A@\\\\n' negative"
test_rawhide "$rh -L '%0 25A@\n'   $d/f2" "-00000311423548.000000000\n" ""                                     0 "-L '%0 25A@\\\\n' negative"
test_rawhide "$rh -L '%+ 25A@\n'   $d/f2" "     -311423548.000000000\n" ""                                     0 "-L '%+ 25A@\\\\n' negative"
test_rawhide "$rh -L '%0+ 25A@\n'  $d/f2" "-00000311423548.000000000\n" ""                                     0 "-L '%0+ 25A@\\\\n' negative"
rm $d/f2

test_rawhide "$rh -L '%Td\n'            $d/f" "18\n"                                       ""                                         0 "-L '%Td\\\\n'"
test_rawhide "$rh -L '%5Td\n'           $d/f" "   18\n"                                    ""                                         0 "-L '%5Td\\\\n'"
test_rawhide "$rh -L '%-5Td\n'          $d/f" "18   \n"                                    ""                                         0 "-L '%-5Td\\\\n'"
test_rawhide "$rh -L '%6.5Td\n'         $d/f" "    18\n"                                   ""                                         0 "-L '%6.5Td\\\\n'"
test_rawhide "$rh -L '%-6.5Td\n'        $d/f" "18    \n"                                   ""                                         0 "-L '%-6.5Td\\\\n'"

test_rawhide "$rh -L '%TH\n'            $d/f" "13\n"                                       ""                                         0 "-L '%TH\\\\n'"
test_rawhide "$rh -L '%5TH\n'           $d/f" "   13\n"                                    ""                                         0 "-L '%5TH\\\\n'"
test_rawhide "$rh -L '%-5TH\n'          $d/f" "13   \n"                                    ""                                         0 "-L '%-5TH\\\\n'"
test_rawhide "$rh -L '%6.5TH\n'         $d/f" "    13\n"                                   ""                                         0 "-L '%6.5TH\\\\n'"
test_rawhide "$rh -L '%-6.5TH\n'        $d/f" "13    \n"                                   ""                                         0 "-L '%-6.5TH\\\\n'"

idch="[a-zA-Z0-9._-]"
test_rawhide_grep "$rh -L '%u\n'        $d/f" "^$idch+\$"                                  ""                                         0 "-L '%u\\\\n' (ok to fail with bizarre user name)"
test_rawhide_grep "$rh -L '%5u\n'       $d/f" "^ *$idch+\$"                                ""                                         0 "-L '%5u\\\\n'"
test_rawhide_grep "$rh -L '%-5u\n'      $d/f" "^$idch+ *\$"                                ""                                         0 "-L '%-5u\\\\n'"
test_rawhide_grep "$rh -L '%6.5u\n'     $d/f" "^ +$idch+\$"                                ""                                         0 "-L '%6.5u\\\\n'"
test_rawhide_grep "$rh -L '%-6.5u\n'    $d/f" "^$idch+ +\$"                                ""                                         0 "-L '%-6.5u\\\\n'"

test_rawhide_grep "$rh -L '%U\n'        $d/f" "^$num\$"                                    ""                                         0 "-L '%U\\\\n'"
test_rawhide_grep "$rh -L '%25U\n'      $d/f" "^ *$num\$"                                  ""                                         0 "-L '%25U\\\\n'"
test_rawhide_grep "$rh -L '%025U\n'     $d/f" "^0$num\$"                                   ""                                         0 "-L '%025U\\\\n'"
test_rawhide_grep "$rh -L '% 25U\n'     $d/f" "^ +$num\$"                                  ""                                         0 "-L '% 25U\\\\n'"
test_rawhide_grep "$rh -L '%+25U\n'     $d/f" "^ +\+$num\$"                                ""                                         0 "-L '%+25U\\\\n'"
test_rawhide_grep "$rh -L '%-25U\n'     $d/f" "^$num +\$"                                  ""                                         0 "-L '%-25U\\\\n'"
test_rawhide_grep "$rh -L '%#25U\n'     $d/f" "^ *$num\$"                                  ""                                         0 "-L '%#25U\\\\n'"
test_rawhide_grep "$rh -L '%.5U\n'      $d/f" "^$num\$"                                    ""                                         0 "-L '%.5U\\\\n'"
test_rawhide_grep "$rh -L '%25.5U\n'    $d/f" "^ *$num\$"                                  ""                                         0 "-L '%25.5U\\\\n'"
test_rawhide_grep "$rh -L '%-25.5U\n'   $d/f" "^$num *\$"                                  ""                                         0 "-L '%-25.5U\\\\n'"
ln -s f $d/l

# major() and minor() can be negtive on FreeBSD (but only %v seems to be)
test_rawhide_grep "$rh -L '%v\n'        $d/f"                          "^-?[0-9]+\$"       ""                                         0 "-L '%v\\\\n'"
test_rawhide_grep "$rh -L '%25v\n'      $d/f"                          "^ +-?[0-9]+\$"     ""                                         0 "-L '%25v\\\\n'"
test_rawhide_grep "$rh -L '%025v\n'     $d/f"                          "^-?0[0-9]+\$"      ""                                         0 "-L '%025v\\\\n'"
test_rawhide_grep "$rh -L '% 25v\n'     $d/f"                          "^ +-?[0-9]+\$"     ""                                         0 "-L '% 25v\\\\n'"
test_rawhide_grep "$rh -L '%+25v\n'     $d/f"                          "^ +[+-][0-9]+\$"   ""                                         0 "-L '%+25v\\\\n'"
test_rawhide_grep "$rh -L '%-25v\n'     $d/f"                          "^-?[0-9]+ +\$"     ""                                         0 "-L '%-25v\\\\n'"
test_rawhide_grep "$rh -L '%#25v\n'     $d/f"                          "^ +-?[0-9]+\$"     ""                                         0 "-L '%#25v\\\\n'"
test_rawhide_grep "$rh -L '%.5v\n'      $d/f"                          "^-?[0-9]+\$"       ""                                         0 "-L '%.5v\\\\n'"
test_rawhide_grep "$rh -L '%25.5v\n'    $d/f"                          "^ +-?[0-9]+\$"     ""                                         0 "-L '%25.5v\\\\n'"
test_rawhide_grep "$rh -L '%-25.5v\n'   $d/f"                          "^-?[0-9]+ +\$"     ""                                         0 "-L '%-25.5v\\\\n'"

test_rawhide_grep "$rh -L '%V\n'        $d/f"                          "^-?[0-9]+\$"       ""                                         0 "-L '%V\\\\n'"
test_rawhide_grep "$rh -L '%25V\n'      $d/f"                          "^ +-?[0-9]+\$"     ""                                         0 "-L '%25V\\\\n'"
test_rawhide_grep "$rh -L '%025V\n'     $d/f"                          "^-?0[0-9]+\$"      ""                                         0 "-L '%025V\\\\n'"
test_rawhide_grep "$rh -L '% 25V\n'     $d/f"                          "^ +-?[0-9]+\$"     ""                                         0 "-L '% 25V\\\\n'"
test_rawhide_grep "$rh -L '%+25V\n'     $d/f"                          "^ +[+-][0-9]+\$"   ""                                         0 "-L '%+25V\\\\n'"
test_rawhide_grep "$rh -L '%-25V\n'     $d/f"                          "^-?[0-9]+ +\$"     ""                                         0 "-L '%-25V\\\\n'"
test_rawhide_grep "$rh -L '%#25V\n'     $d/f"                          "^ +-?[0-9]+\$"     ""                                         0 "-L '%#25V\\\\n'"
test_rawhide_grep "$rh -L '%.5V\n'      $d/f"                          "^-?[0-9]+\$"       ""                                         0 "-L '%.5V\\\\n'"
test_rawhide_grep "$rh -L '%25.5V\n'    $d/f"                          "^ +-?[0-9]+\$"     ""                                         0 "-L '%25.5V\\\\n'"
test_rawhide_grep "$rh -L '%-25.5V\n'   $d/f"                          "^-?[0-9]+ +\$"     ""                                         0 "-L '%-25.5V\\\\n'"

# For %x %X, see tests/t27

test_rawhide "$rh -L '%y\n' -M0         $d" "d\n"                                          ""                                         0 "-L '%y\\\\n'"
test_rawhide "$rh -L '%5y\n' -M0        $d" "    d\n"                                      ""                                         0 "-L '%5y\\\\n'"
test_rawhide "$rh -L '%-5y\n' -M0       $d" "d    \n"                                      ""                                         0 "-L '%-5y\\\\n'"
test_rawhide "$rh -L '%6.0y\n' -M0      $d" "      \n"                                     ""                                         0 "-L '%6.0y\\\\n'"
test_rawhide "$rh -L '%-6.0y\n' -M0     $d" "      \n"                                     ""                                         0 "-L '%-6.0y\\\\n'"

test_rawhide "$rh -L '%y\n'             $d/f" "f\n"                                        ""                                                 0 "-L '%y\\\\n'"
test_rawhide "$rh -L '%5y\n'            $d/f" "    f\n"                                    ""                                         0 "-L '%5y\\\\n'"
test_rawhide "$rh -L '%-5y\n'           $d/f" "f    \n"                                    ""                                         0 "-L '%-5y\\\\n'"
test_rawhide "$rh -L '%6.0y\n'          $d/f" "      \n"                                   ""                                         0 "-L '%6.0y\\\\n'"
test_rawhide "$rh -L '%-6.0y\n'         $d/f" "      \n"                                   ""                                         0 "-L '%-6.0y\\\\n'"

test_rawhide "$rh -L '%y\n'             $d/l" "l\n"                                        ""                                                 0 "-L '%y\\\\n'"
test_rawhide "$rh -L '%5y\n'            $d/l" "    l\n"                                    ""                                         0 "-L '%5y\\\\n'"
test_rawhide "$rh -L '%-5y\n'           $d/l" "l    \n"                                    ""                                         0 "-L '%-5y\\\\n'"
test_rawhide "$rh -L '%6.0y\n'          $d/l" "      \n"                                   ""                                         0 "-L '%6.0y\\\\n'"
test_rawhide "$rh -L '%-6.0y\n'         $d/l" "      \n"                                   ""                                         0 "-L '%-6.0y\\\\n'"

test_rawhide "$rh -L '%Y\n' -M0         $d" "d\n"                                          ""                                         0 "-L '%Y\\\\n'"
test_rawhide "$rh -L '%5Y\n' -M0        $d" "    d\n"                                      ""                                         0 "-L '%5Y\\\\n'"
test_rawhide "$rh -L '%-5Y\n' -M0       $d" "d    \n"                                      ""                                         0 "-L '%-5Y\\\\n'"
test_rawhide "$rh -L '%6.0Y\n' -M0      $d" "      \n"                                     ""                                         0 "-L '%6.0Y\\\\n'"
test_rawhide "$rh -L '%-6.0Y\n' -M0     $d" "      \n"                                     ""                                         0 "-L '%-6.0Y\\\\n'"

test_rawhide "$rh -L '%Y\n'             $d/f" "f\n"                                        ""                                         0 "-L '%Y\\\\n'"
test_rawhide "$rh -L '%5Y\n' -M0        $d/f" "    f\n"                                    ""                                         0 "-L '%5Y\\\\n'"
test_rawhide "$rh -L '%-5Y\n' -M0       $d/f" "f    \n"                                    ""                                         0 "-L '%-5Y\\\\n'"
test_rawhide "$rh -L '%6.0Y\n' -M0      $d/f" "      \n"                                   ""                                         0 "-L '%6.0Y\\\\n'"
test_rawhide "$rh -L '%-6.0Y\n' -M0     $d/f" "      \n"                                   ""                                         0 "-L '%-6.0Y\\\\n'"

test_rawhide "$rh -L '%Y\n'             $d/l" "f\n"                                        ""                                         0 "-L '%Y\\\\n'"
test_rawhide "$rh -L '%5Y\n' -M0        $d/l" "    f\n"                                    ""                                         0 "-L '%5Y\\\\n'"
test_rawhide "$rh -L '%-5Y\n' -M0       $d/l" "f    \n"                                    ""                                         0 "-L '%-5Y\\\\n'"
test_rawhide "$rh -L '%6.0Y\n' -M0      $d/l" "      \n"                                   ""                                         0 "-L '%6.0Y\\\\n'"
test_rawhide "$rh -L '%-6.0Y\n' -M0     $d/l" "      \n"                                   ""                                         0 "-L '%-6.0Y\\\\n'"

ln -s broken $d/bl
test_rawhide "$rh -L '%y\n'             $d/bl" "l\n"                                        ""                                         0 "-L '%y\\\\n' (broken)"
test_rawhide "$rh -L '%Y\n'             $d/bl" "N\n"                                        ""                                         0 "-L '%Y\\\\n' (broken)"
rm $d/bl

ln -s loop $d/ll
ln -s ll $d/loop
test_rawhide "$rh -L '%y\n'             $d/ll" "l\n"                                        ""                                         0 "-L '%y\\\\n' (loop)"
test_rawhide "$rh -L '%Y\n'             $d/ll" "L\n"                                        ""                                         0 "-L '%Y\\\\n' (loop)"
rm $d/ll $d/loop

test_rawhide_grep "$rh -L '%j\n'        $d/f"    "^\\{\"path\":\"$d/f\", .*\\}$"                     "" 0 "-L %j (json) file"
test_rawhide_grep "$rh -j               $d/f"    "^\\{\"path\":\"$d/f\", .*\\}$"                     "" 0 "-j (json) file"
test_rawhide_grep "$rh -L '%j\n'        $d/l"    "^\\{\"path\":\"$d/l\", .*\"target\":\"f\", .*\\}$" "" 0 "-L %j (json) symlink"
test_rawhide_grep "$rh -j               $d/l"    "^\\{\"path\":\"$d/l\", .*\"target\":\"f\", .*\\}$" "" 0 "-j (json) symlink"
touch "$d/`printf 'abc\ndef\a'`"
test_rawhide_grep "$rh -L '%j\n'        $d/abc*" "^\\{\"path\":\"$d/abc\\\\ndef\\\\u0007\", .*\\}$"  "" 0 "-L %j (json) file with binary name"
test_rawhide_grep "$rh -j               $d/abc*" "^\\{\"path\":\"$d/abc\\\\ndef\\\\u0007\", .*\\}$"  "" 0 "-j (json) file with binary name"
rm $d/abc*

if [ `locale charmap` = UTF-8 ]
then
	touch "$d/`printf 'abc\ndef\a\360\236\235\277'`" 2>/dev/null # Last four bytes are an undefined unicode char U+1e77f that requires a UTF-16 surrogate pair in json
	if [ $? = 0 ] # macOS can't create this file
	then
		test_rawhide_grep "$rh -L '%j\n'        $d/abc*" "^\\{\"path\":\"$d/abc\\\\ndef\\\\u0007\\\\ud839\\\\udf7f\", .*\\}$"  "" 0 "-L %j (json) file with binary name"
		test_rawhide_grep "$rh -j               $d/abc*" "^\\{\"path\":\"$d/abc\\\\ndef\\\\u0007\\\\ud839\\\\udf7f\", .*\\}$"  "" 0 "-j (json) file with binary name"
		rm $d/abc*
	fi
fi

# For %z %Z, see tests/t27

# Suppress %Z tests when selinux is actually enabled (ironically),
# because we can't predict the labels in use (might be default, might not be).
selinux="`$rh -L '%Z\n' $d/f`"
if [ -z "$selinux" ]
then
	test_rawhide "$rh -L '%Z\n'         $d/f" "\n"                                         ""                                         0 "-L '%Z\\\\n'"
	test_rawhide "$rh -L '%5Z\n' -M0    $d/f" "     \n"                                    ""                                         0 "-L '%5Z\\\\n'"
	test_rawhide "$rh -L '%-5Z\n' -M0   $d/f" "     \n"                                    ""                                         0 "-L '%-5Z\\\\n'"
else
	# Tautology, but at least it's something
	test_rawhide "$rh -L '%Z\n'         $d/f" "$selinux\n"                                 ""                                         0 "-L '%Z\\\\n'"
fi
test_rawhide "$rh -L '%6.0Z\n' -M0      $d/f" "      \n"                                   ""                                         0 "-L '%6.0Z\\\\n'"
test_rawhide "$rh -L '%-6.0Z\n' -M0     $d/f" "      \n"                                   ""                                         0 "-L '%-6.0Z\\\\n'"

test_rawhide "$rh -L '%Q\n'             $d/f" ""                                           "./rh: invalid -L argument: %%Q\\\\n (invalid conversion: %%Q)\n"   1 "-L '%Q\\\\n' (error)"
test_rawhide "$rh -L 'a%Qz\n'           $d/f" "a"                                          "./rh: invalid -L argument: a%%Qz\\\\n (invalid conversion: %%Q)\n" 1 "-L 'a%Qz\\\\n' (error)"

test_rawhide "RAWHIDE_TEST_TTY=1 $rh -L '%Q\n' $d/f" ""                                    "./rh: invalid -L argument: %%Q\\\\n (invalid conversion: %%Q)\n"   1 "-L '%Q\\\\n' (error (with oklen) to tty)"

test_rawhide "                   $rh -L '%$(printf '\370')\n' $d/f" ""                     "./rh: invalid -L argument: %%$(printf '\370')\\\\n (invalid conversion: %%$(printf '\370'))\n"   1 "-L '%\$(printf '\\\370')\\\\n' (error (with oklen) to non-tty with invalid byte sequence)"
test_rawhide "RAWHIDE_TEST_TTY=1 $rh -L '%$(printf '\370')\n' $d/f" ""                     "./rh: invalid -L argument: %%?\\\\n (invalid conversion: %%?)\n"   1 "-L '%\$(printf '\\\370')\\\\n' (error (with oklen) to tty with invalid byte sequence)"

test_rawhide "                   $rh -L '%$(printf '\233')\n' $d/f" ""                     "./rh: invalid -L argument: %%$(printf '\233')\\\\n (invalid conversion: %%$(printf '\233'))\n"   1 "-L '%\$(printf '\\\233')\\\\n' (error (with oklen) to non-tty with latin1 non-printable/control char CSI or invalid utf8)"
test_rawhide "RAWHIDE_TEST_TTY=1 $rh -L '%$(printf '\233')\n' $d/f" ""                     "./rh: invalid -L argument: %%?\\\\n (invalid conversion: %%?)\n"   1 "-L '%\$(printf '\\\233')\\\\n' (error (with oklen) to tty with latin1 non-printable/control char CSI or invalid utf8)"

if [ `locale charmap` = 'UTF-8' ]
then
	test_rawhide "                   $rh -L '%$(printf '\302\233')\n' $d/f" ""             "./rh: invalid -L argument: %%$(printf '\302\233')\\\\n (invalid conversion: %%$(printf '\302\233'))\n"   1 "-L '%\$(printf '\\\302\\\233')\\\\n' (error (with oklen) to non-tty with utf8 non-printable/control char CSI)"
	test_rawhide "RAWHIDE_TEST_TTY=1 $rh -L '%$(printf '\302\233')\n' $d/f" ""             "./rh: invalid -L argument: %%?\\\\n (invalid conversion: %%?)\n"   1 "-L '%\$(printf '\\\302\\\233')\\\\n' (error (with oklen) to tty with utf8 non-printable/control char CSI)"
fi

test_rawhide "$rh -L '%'                $d/f" ""                                           "./rh: invalid -L argument: %% (%% at the end)\n"  1 "-L 'a%' (error)"
test_rawhide "$rh -L 'a%'               $d/f" "a"                                          "./rh: invalid -L argument: a%% (%% at the end)\n" 1 "-L 'a%' (error)"
rm $d/l

# ofmt size is 33, inode needs 3 for %lld and 2 for nul
test_rawhide_grep "$rh -L '%-------------------------010i\n'  $d/f"  "^$num *\$"           ""                                                                                                                      0 "-L '%-------------------------010i' (not too long)"
test_rawhide      "$rh -L '%--------------------------010i\n'  $d/f" ""                    "./rh: invalid -L argument: %%--------------------------010i\\\\n (conversion flags/width/precision too long)\n" 1 "-L '%--------------------------010i' (too long)"

# For -L %x %X see tests/t27

# %e (ext2-style attributes) %J (project) %I (generation) (requires e2fsprogs (libe2p and chattr))

if [ "`whoami`" = root ]
then
	if $rh -h | grep -wq proj # Linux
	then
		if [ -n "`command -v chattr`" ]
		then
			test_rawhide_post_hook() { test_rh_sort_post_hook; }
			mkdir $d/d
			touch $d/f
			ln -s d $d/ld
			ln -s f $d/lf
			chattr +a $d/d
			chattr +a $d/f

			test_rawhide_grep "$rh -e 'd && attr & 0x00000020' -L '%p %e\n' $d" "$d/d .*append.*" "" 0 "-L %e (attribute) d"
			test_rawhide_grep "$rh -e 'f && attr & 0x00000020' -L '%p %e\n' $d" "$d/f .*append.*" "" 0 "-L %e (attribute) f"
			test_rawhide_grep "$rh -e 'd && attr & 0x00000020' -L '%p %J\n' $d" "$d/d [0-9]+"     "" 0 "-L %J (project) d"
			test_rawhide_grep "$rh -e 'f && attr & 0x00000020' -L '%p %J\n' $d" "$d/f [0-9]+"     "" 0 "-L %J (project) f"
			test_rawhide_grep "$rh -e 'd && attr & 0x00000020' -L '%p %I\n' $d" "$d/d [0-9]+"     "" 0 "-L %I (version/generation) d"
			test_rawhide_grep "$rh -e 'f && attr & 0x00000020' -L '%p %I\n' $d" "$d/f [0-9]+"     "" 0 "-L %I (version/generation) f"

			test_rawhide_grep "$rh -e 'f && attr & 0x00000020' -L '%e\n'      $d/f" "^[^ ].*[^ ]$" "" 0 "-L '%e\\\\n' $d/f"
			test_rawhide_grep "$rh -e 'f && attr & 0x00000020' -L '%15e\n'    $d/f" "^ +.+$"       "" 0 "-L '%15e\\\\n' $d/f"
			test_rawhide_grep "$rh -e 'f && attr & 0x00000020' -L '%-15e\n'   $d/f" "^.+ +$"       "" 0 "-L '%-15e\\\\n' $d/f"
			test_rawhide_grep "$rh -e 'f && attr & 0x00000020' -L '%15.5e\n'  $d/f" "^ +.....$"    "" 0 "-L '%15.5e\\\\n' $d/f"
			test_rawhide_grep "$rh -e 'f && attr & 0x00000020' -L '%-15.5e\n' $d/f" "^..... +$"    "" 0 "-L '%-15.5e\\\\n' $d/f"

			test_rawhide_grep "$rh -e 'f && attr & 0x00000020' -L '%J\n'      $d/f" "^$num\$"     "" 0 "-L '%J\\\\n'"
			test_rawhide_grep "$rh -e 'f && attr & 0x00000020' -L '%25J\n'    $d/f" "^ +$num\$"   "" 0 "-L '%25J\\\\n'"
			test_rawhide_grep "$rh -e 'f && attr & 0x00000020' -L '%025J\n'   $d/f" "^0$num\$"    "" 0 "-L '%025J\\\\n'"
			test_rawhide_grep "$rh -e 'f && attr & 0x00000020' -L '% 25J\n'   $d/f" "^ +$num\$"   "" 0 "-L '% 25J\\\\n'"
			test_rawhide_grep "$rh -e 'f && attr & 0x00000020' -L '%+25J\n'   $d/f" "^ +\+$num\$" "" 0 "-L '%+25J\\\\n'"
			test_rawhide_grep "$rh -e 'f && attr & 0x00000020' -L '%-25J\n'   $d/f" "^$num +\$"   "" 0 "-L '%-25J\\\\n'"
			test_rawhide_grep "$rh -e 'f && attr & 0x00000020' -L '%#25J\n'   $d/f" "^ +$num\$"   "" 0 "-L '%#25J\\\\n'"
			test_rawhide_grep "$rh -e 'f && attr & 0x00000020' -L '%.5J\n'    $d/f" "^$num\$"     "" 0 "-L '%.5J\\\\n'"
			test_rawhide_grep "$rh -e 'f && attr & 0x00000020' -L '%25.5J\n'  $d/f" "^ +$num\$"   "" 0 "-L '%25.5J\\\\n'"
			test_rawhide_grep "$rh -e 'f && attr & 0x00000020' -L '%-25.5J\n' $d/f" "^$num +\$"   "" 0 "-L '%-25.5J\\\\n'"

			test_rawhide_grep "$rh -e 'f && attr & 0x00000020' -L '%I\n'      $d/f" "^$num\$"     "" 0 "-L '%I\\\\n'"
			test_rawhide_grep "$rh -e 'f && attr & 0x00000020' -L '%25I\n'    $d/f" "^ +$num\$"   "" 0 "-L '%25I\\\\n'"
			test_rawhide_grep "$rh -e 'f && attr & 0x00000020' -L '%025I\n'   $d/f" "^0$num\$"    "" 0 "-L '%025I\\\\n'"
			test_rawhide_grep "$rh -e 'f && attr & 0x00000020' -L '% 25I\n'   $d/f" "^ +$num\$"   "" 0 "-L '% 25I\\\\n'"
			test_rawhide_grep "$rh -e 'f && attr & 0x00000020' -L '%+25I\n'   $d/f" "^ +\+$num\$" "" 0 "-L '%+25I\\\\n'"
			test_rawhide_grep "$rh -e 'f && attr & 0x00000020' -L '%-25I\n'   $d/f" "^$num +\$"   "" 0 "-L '%-25I\\\\n'"
			test_rawhide_grep "$rh -e 'f && attr & 0x00000020' -L '%#25I\n'   $d/f" "^ +$num\$"   "" 0 "-L '%#25I\\\\n'"
			test_rawhide_grep "$rh -e 'f && attr & 0x00000020' -L '%.5I\n'    $d/f" "^$num\$"     "" 0 "-L '%.5I\\\\n'"
			test_rawhide_grep "$rh -e 'f && attr & 0x00000020' -L '%25.5I\n'  $d/f" "^ +$num\$"   "" 0 "-L '%25.5I\\\\n'"
			test_rawhide_grep "$rh -e 'f && attr & 0x00000020' -L '%-25.5I\n' $d/f" "^$num +\$"   "" 0 "-L '%-25.5I\\\\n'"

			# For test coverage
			test_rawhide_grep "RAWHIDE_TEST_ATTR_FORMAT=1 $rh -e 'd && attr & 0x00000020' -L '%p %e\n' $d" "$d/d secrm unrm .*" "" 0 "-L %e (attribute) d all attributes"

			chattr -a $d/d
			chattr -a $d/f
			rm $d/ld $d/lf $d/f
			rmdir $d/d
			test_rawhide_post_hook() { true; }
		fi
	elif $rh -h | grep -wq attr # FreeBSD, OpenBSD, NetBSD, macOS, Solaris
	then
		case "`uname`" in
			SunOS|Solaris)
				touch $d/f
				chmod S+ci $d/f >/dev/null 2>/dev/null
				if [ $? = 0 ]
				then
					test_rawhide_grep "$rh -e 'attr & 0x0020' -L '%p %e\n'   $d" "$d/f .*immutable.*" "" 0 "-L %e (attribute)"

					test_rawhide_grep "$rh -e 'attr & 0x0020' -L '%e\n'      $d/f" "^[^ ].*[^ ]$" "" 0 "-L '%e\\\\n' $d/f"
					test_rawhide_grep "$rh -e 'attr & 0x0020' -L '%50e\n'    $d/f" "^ +.+$"       "" 0 "-L '%50e\\\\n' $d/f"
					test_rawhide_grep "$rh -e 'attr & 0x0020' -L '%-50e\n'   $d/f" "^.+ +$"       "" 0 "-L '%-50e\\\\n' $d/f"
					test_rawhide_grep "$rh -e 'attr & 0x0020' -L '%50.5e\n'  $d/f" "^ +.....$"    "" 0 "-L '%50.5e\\\\n' $d/f"
					test_rawhide_grep "$rh -e 'attr & 0x0020' -L '%-50.5e\n' $d/f" "^..... +$"    "" 0 "-L '%-50.5e\\\\n' $d/f"
					chmod S-ci $d/f
				fi
				rm $d/f
				;;
			*)
				if [ -n "`command -v chflags`" ]
				then
					case `sysctl -n kern.securelevel` in
						-1|0)
							test_rawhide_post_hook() { test_rh_sort_post_hook; }
							mkdir $d/d
							touch $d/f
							ln -s d $d/ld
							ln -s f $d/lf
							# uappnd works on OpenBSD and NetBSD and macOS,
							# but now fails on FreeBSD, but sappnd works on FreeBSD
							if chflags uappnd $d/d $d/f 2>/dev/null
							then
								test_rawhide_grep "$rh -e 'd && attr & 0x00000004' -L '%p %e\n' $d" "$d/d .*append.*" "" 0 "-L %e (attribute) d"
								test_rawhide_grep "$rh -e 'f && attr & 0x00000004' -L '%p %e\n' $d" "$d/f .*append.*" "" 0 "-L %e (attribute) f"

								test_rawhide_grep "$rh -e 'f && attr & 0x00000004' -L '%e\n'      $d/f" "^[^ ].*[^ ]$" "" 0 "-L '%e\\\\n' $d/f"
								test_rawhide_grep "$rh -e 'f && attr & 0x00000004' -L '%15e\n'    $d/f" "^ +.+$"       "" 0 "-L '%15e\\\\n' $d/f"
								test_rawhide_grep "$rh -e 'f && attr & 0x00000004' -L '%-15e\n'   $d/f" "^.+ +$"       "" 0 "-L '%-15e\\\\n' $d/f"
								test_rawhide_grep "$rh -e 'f && attr & 0x00000004' -L '%15.5e\n'  $d/f" "^ +.....$"    "" 0 "-L '%15.5e\\\\n' $d/f"
								test_rawhide_grep "$rh -e 'f && attr & 0x00000004' -L '%-15.5e\n' $d/f" "^..... +$"    "" 0 "-L '%-15.5e\\\\n' $d/f"

								# For test coverage
								test_rawhide_grep "RAWHIDE_TEST_ATTR_FORMAT=1 $rh -e 'd && attr & 0x00000004' -L '%p %e\n' $d" "$d/d .*append.*" "" 0 "-L %e (attribute) d all attributes"

								chflags nouappnd $d/d $d/f
							elif chflags sappend $d/d $d/f
							then
								test_rawhide_grep "$rh -e 'd && attr & 0x00040000' -L '%p %e\n' $d" "$d/d .*append.*" "" 0 "-L %e (attribute) d"
								test_rawhide_grep "$rh -e 'f && attr & 0x00040000' -L '%p %e\n' $d" "$d/f .*append.*" "" 0 "-L %e (attribute) f"

								test_rawhide_grep "$rh -e 'f && attr & 0x00040000' -L '%e\n'      $d/f" "^[^ ].*[^ ]$" "" 0 "-L '%e\\\\n' $d/f"
								test_rawhide_grep "$rh -e 'f && attr & 0x00040000' -L '%16e\n'    $d/f" "^ +.+$"       "" 0 "-L '%16e\\\\n' $d/f"
								test_rawhide_grep "$rh -e 'f && attr & 0x00040000' -L '%-16e\n'   $d/f" "^.+ +$"       "" 0 "-L '%-16e\\\\n' $d/f"
								test_rawhide_grep "$rh -e 'f && attr & 0x00040000' -L '%16.5e\n'  $d/f" "^ +.....$"    "" 0 "-L '%16.5e\\\\n' $d/f"
								test_rawhide_grep "$rh -e 'f && attr & 0x00040000' -L '%-16.5e\n' $d/f" "^..... +$"    "" 0 "-L '%-16.5e\\\\n' $d/f"

								# For test coverage
								test_rawhide_grep "RAWHIDE_TEST_ATTR_FORMAT=1 $rh -e 'd && attr & 0x00040000' -L '%p %e\n' $d" "$d/d .*append.*" "" 0 "-L %e (attribute) d all attributes"

								chflags nouappnd $d/d $d/f
							else
								echo "$t: Skipping chflags tests (chflags uappnd/sappend failed)"
							fi

							rm -f $d/ld $d/lf $d/f
							rmdir $d/d
							test_rawhide_post_hook() { true; }
							;;
						*)
							echo "$t: Skipping chflags tests (kern.securelevel is too high)"
							;;
					esac
				fi
				;;
		esac
	fi
fi

if $rh -h | grep -wq what
then
	test_rawhide_post_hook() { test_rh_sort_post_hook; }
	mkdir $d/d
	touch $d/f
	test_rawhide_grep "$rh -L '%w\n' $d/f" "^empty$"          "" 0 "-L %w f (filetype)"
	test_rawhide_grep "$rh -L '%w\n' $d/d" "^directory$"      "" 0 "-L %w d (filetype)"
	test_rawhide_grep "$rh -L '%W\n' $d/f" "^inode/x-empty"   "" 0 "-L %W f (mimetype)"
	test_rawhide_grep "$rh -L '%W\n' $d/d" "^inode/directory" "" 0 "-L %W d (mimetype)"
	rm $d/f
	rmdir $d/d
	test_rawhide_post_hook() { true; }
fi

finish

exit $errors

# vi:set ts=4 sw=4:
